<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal & Home Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'theme-dark': '#234E70',
                'theme-light': '#fbf8BE',
              }
            }
          }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #234E70; /* Theme Dark */
            color: #fbf8BE; /* Theme Light */
        }
        .glass-card {
            background: rgba(251, 248, 190, 0.05); /* Light theme with opacity */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 12px;
            border: 1px solid rgba(251, 248, 190, 0.15);
        }
        .modal-backdrop {
             background: rgba(35, 78, 112, 0.7); /* Dark theme with opacity */
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
        }
        .nav-button { transition: all 0.3s ease; position: relative; }
        .nav-button.active { color: #fbf8BE; font-weight: 600; }
        .nav-button.active::after { content: ''; position: absolute; bottom: -4px; left: 0; right: 0; height: 2px; background-color: #fbf8BE; border-radius: 1px; }
        .toast { animation: slideInRight 0.5s ease-out, fadeOut 0.5s ease-in 2.5s; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .account-type-card { transition: all 0.2s ease-in-out; }
        .account-type-card:hover { transform: translateY(-5px); background: rgba(251, 248, 190, 0.1); }
        input, select {
            color-scheme: dark;
        }
        .text-theme-dark {
             color: #234E70;
        }
    </style>
</head>
<body class="antialiased bg-theme-dark text-theme-light">

    <!-- Login View -->
    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <div class="glass-card p-10 max-w-md w-full">
            <i data-lucide="wallet" class="w-16 h-16 text-theme-light mx-auto mb-4"></i>
            <h1 class="text-3xl font-bold text-theme-light mb-2">Expense Tracker</h1>
            <p class="text-theme-light/70 mb-8">Sign in to access your synced finances.</p>
            <button id="signInBtn" class="w-full flex items-center justify-center gap-3 bg-theme-light text-theme-dark font-semibold py-3 px-6 rounded-lg hover:bg-theme-light/90 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Sign In with Google
            </button>
        </div>
    </div>

    <!-- Main App View (Initially Hidden) -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <header class="flex justify-between items-center mb-8">
            <div id="userProfile" class="flex items-center gap-3"></div>
            <nav class="glass-card p-2 rounded-full">
                <div id="mainNav" class="flex items-center gap-2">
                    <button onclick="switchView('personal')" data-view="personal" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-theme-light/80">Personal</button>
                    <button onclick="switchView('home')" data-view="home" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-theme-light/80">Home</button>
                    <button onclick="switchView('accounts')" data-view="accounts" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-theme-light/80">Accounts</button>
                </div>
            </nav>
             <button id="signOutBtn" class="text-theme-light/70 hover:text-theme-light transition-all"><i data-lucide="log-out" class="w-6 h-6"></i></button>
        </header>
        <main id="viewContainer"></main>
    </div>
    
    <!-- ALL MODALS -->
    <div id="addPersonalTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addPersonalTransactionModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addPersonalTransactionModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-theme-light mb-6">Add Personal Transaction</h2><form id="addPersonalTransactionForm" class="space-y-4"><div><label for="personalTxDate" class="block text-xs font-medium text-theme-light/70 mb-1">Date</label><input type="date" id="personalTxDate" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="personalTxType" class="block text-xs font-medium text-theme-light/70 mb-1">Type</label><select id="personalTxType" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required><option value="expense">Expense</option><option value="income">Income</option></select></div><div><label for="personalTxAccount" class="block text-xs font-medium text-theme-light/70 mb-1">Account</label><select id="personalTxAccount" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="personalTxCategory" class="block text-xs font-medium text-theme-light/70 mb-1">Category</label><select id="personalTxCategory" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><div><label for="personalTxAmount" class="block text-xs font-medium text-theme-light/70 mb-1">Amount</label><input type="number" id="personalTxAmount" placeholder="0.00" step="0.01" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div></div><div><label for="personalTxDescription" class="block text-xs font-medium text-theme-light/70 mb-1">Description</label><input type="text" id="personalTxDescription" placeholder="e.g., Lunch" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><button type="submit" class="w-full p-4 bg-theme-light text-theme-dark font-bold rounded-lg hover:bg-theme-light/90">Save</button></form></div></div>
    <div id="addHomeTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addHomeTransactionModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addHomeTransactionModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-theme-light mb-6">Add Home Transaction</h2><form id="addHomeTransactionForm" class="space-y-4"><div><label for="homeTxDate" class="block text-xs font-medium text-theme-light/70 mb-1">Date</label><input type="date" id="homeTxDate" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="homeTxType" class="block text-xs font-medium text-theme-light/70 mb-1">Type</label><select id="homeTxType" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required><option value="expense">Expense</option><option value="income">Income</option></select></div><div><label for="homeTxAccount" class="block text-xs font-medium text-theme-light/70 mb-1">Account</label><select id="homeTxAccount" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="homeTxCategory" class="block text-xs font-medium text-theme-light/70 mb-1">Category</label><select id="homeTxCategory" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><div><label for="homeTxAmount" class="block text-xs font-medium text-theme-light/70 mb-1">Amount</label><input type="number" id="homeTxAmount" placeholder="0.00" step="0.01" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div></div><div><label for="homeTxDescription" class="block text-xs font-medium text-theme-light/70 mb-1">Description</label><input type="text" id="homeTxDescription" placeholder="e.g., Groceries" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><button type="submit" class="w-full p-4 bg-theme-light text-theme-dark font-bold rounded-lg hover:bg-theme-light/90">Save</button></form></div></div>
    <div id="addAccountTypeModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addAccountTypeModal')"></div><div class="glass-card w-full max-w-2xl m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addAccountTypeModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-center mb-6">Select Account Type</h2><div class="grid grid-cols-2 md:grid-cols-3 gap-4"><button onclick="selectAccountType('Bank')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="landmark" class="w-8 h-8"></i><span>Bank</span></button><button onclick="selectAccountType('Credit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="credit-card" class="w-8 h-8"></i><span>Credit Card</span></button><button onclick="selectAccountType('Debit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="credit-card" class="w-8 h-8"></i><span>Debit Card</span></button><button onclick="selectAccountType('Wallet')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="wallet" class="w-8 h-8"></i><span>Wallet</span></button><button onclick="selectAccountType('UPI')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="zap" class="w-8 h-8"></i><span>UPI</span></button><button onclick="selectAccountType('Cash')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="banknote" class="w-8 h-8"></i><span>Cash</span></button></div></div></div>
    <div id="manageCategoriesModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('manageCategoriesModal')"></div><div class="glass-card w-full max-w-md m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('manageCategoriesModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Manage Categories</h2><form id="addCategoryForm" class="flex gap-2 mb-4"><input type="text" id="newCategoryName" placeholder="New category name" class="flex-grow p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required><button type="submit" class="p-3 bg-theme-light text-theme-dark rounded-lg hover:bg-theme-light/90"><i data-lucide="plus" class="w-6 h-6"></i></button></form><div id="categoryList" class="space-y-2 max-h-60 overflow-y-auto"></div></div></div>
    <div id="addBankAccountModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addBankAccountModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addBankAccountModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addBankAccountForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add Bank Account</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Account Nickname</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Initial Balance</label><input type="number" name="balance" step="0.01" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10"></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    <div id="addCreditCardModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addCreditCardModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addCreditCardModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addCreditCardForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add Credit Card</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Card Nickname</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank</label><select name="linkedBank" id="creditCardLinkedBank" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    <div id="addDebitCardModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addDebitCardModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addDebitCardModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addDebitCardForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add Debit Card</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Card Nickname</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank</label><select name="linkedBank" id="debitCardLinkedBank" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    <div id="addWalletModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addWalletModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addWalletModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addWalletForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add Wallet</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Wallet Name</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Balance</label><input type="number" name="balance" step="0.01" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank</label><select name="linkedBank" id="walletLinkedBank" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    <div id="addUpiModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addUpiModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addUpiModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addUpiForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add UPI</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">App Name</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank</label><select name="linkedBank" id="upiLinkedBank" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></select></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    <div id="addCashModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addCashModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addCashModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><form id="addCashForm" class="space-y-4"><h2 class="text-2xl font-bold mb-6">Add Cash</h2><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Nickname</label><input type="text" name="name" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Balance</label><input type="number" name="balance" step="0.01" class="w-full p-3 bg-theme-light/5 rounded-lg border border-theme-light/10" required></div><button type="submit" class="w-full p-4 mt-4 bg-theme-light text-theme-dark font-bold rounded-lg">Save</button></form></div></div>
    
    <div id="loadingIndicator" class="fixed inset-0 z-[101] items-center justify-center hidden bg-black/50"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-theme-light"></div></div>
    <div id="toastContainer" class="fixed top-5 right-5 z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, increment, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCIYq9g1bCcx82Naieth_-dCo0h154VMo8",
            authDomain: "myexpensetracker-a9118.firebaseapp.com",
            projectId: "myexpensetracker-a9118",
            storageBucket: "myexpensetracker-a9118.appspot.com",
            messagingSenderId: "172584825601",
            appId: "1:172584825601:web:456c446a4ecdab2faa2100",
            measurementId: "G-HQ4FWR8RKH"
        };

        let db, auth, userId, appState = { accounts: [], personalTransactions: [], homeTransactions: [], categories: [], currentView: 'personal' }, charts = {};
        const loginView = document.getElementById('loginView'), appView = document.getElementById('app'), viewContainer = document.getElementById('viewContainer'), loadingIndicator = document.getElementById('loadingIndicator'), mainNav = document.getElementById('mainNav'), signInBtn = document.getElementById('signInBtn'), signOutBtn = document.getElementById('signOutBtn');

        function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loginView.classList.add('hidden');
                        appView.classList.remove('hidden');
                        displayUserProfile(user);
                        fetchInitialData();
                        switchView('personal');
                    } else {
                        userId = null;
                        loginView.classList.remove('hidden');
                        appView.classList.add('hidden');
                        Object.values(charts).forEach(c => c.destroy());
                        charts = {};
                    }
                });
            } catch (err) { console.error("Firebase init error: ", err); showToast("Error connecting to Firebase.", "error"); }
        }

        signInBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error(error); showToast("Failed to sign in.", "error"); } });
        signOutBtn.addEventListener('click', () => signOut(auth));

        function displayUserProfile(user) { document.getElementById('userProfile').innerHTML = `<img src="${user.photoURL}" alt="User" class="w-10 h-10 rounded-full border-2 border-theme-light/30"><div><p class="font-semibold text-sm">${user.displayName}</p><p class="text-xs text-theme-light/70">${user.email}</p></div>`; }

        function fetchInitialData() {
            if (!userId) return;
            ['accounts', 'personalTransactions', 'homeTransactions'].forEach(coll => {
                 onSnapshot(collection(db, `users/${userId}/${coll}`), s => { appState[coll] = s.docs.map(d => ({ id: d.id, ...d.data() })); if(appState.currentView) switchView(appState.currentView); }, e => showToast(`Could not fetch ${coll}.`, 'error'));
            });
            onSnapshot(doc(db, `users/${userId}/appData/categories`), (docSnap) => {
                if (docSnap.exists() && docSnap.data().list) { appState.categories = docSnap.data().list; }
                else { const d = ["Food","Transport","Bills","Shopping","Health","Other"]; setDoc(doc(db, `users/${userId}/appData/categories`),{list:d}); appState.categories=d; }
            });
        }
        
        window.switchView = (v) => {
            appState.currentView = v;
            mainNav.querySelectorAll('.nav-button').forEach(b => b.classList.toggle('active', b.dataset.view === v));
            const renders = { personal: renderPersonalView, home: renderHomeView, accounts: renderAccountsView };
            if (renders[v]) renders[v]();
        };
        
        const renderSummaryAndChart = (view, txs) => {
            const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0), expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            viewContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Balance</h3><p class="text-3xl font-bold mt-2">₹${(income - expense).toFixed(2)}</p></div><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Income</h3><p class="text-3xl font-bold text-green-400 mt-2">₹${income.toFixed(2)}</p></div><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Expense</h3><p class="text-3xl font-bold text-red-400 mt-2">₹${expense.toFixed(2)}</p></div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-3"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Recent Transactions</h2><button id="addTxBtn" class="bg-theme-light hover:bg-theme-light/90 text-theme-dark font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Add</button></div><div id="txList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div></div><div class="lg:col-span-2 glass-card p-6"><h3 class="text-lg font-semibold mb-4">Spending by Category</h3><canvas id="spendingChart"></canvas></div></div>`;
            renderTransactionList('txList', txs); createCategoryDoughnutChart('spendingChart', txs);
        };

        const renderPersonalView = () => renderSummaryAndChart('Personal', appState.personalTransactions);
        const renderHomeView = () => renderSummaryAndChart('Home', appState.homeTransactions);

        document.addEventListener('click', (e) => {
            if (e.target.id === 'addTxBtn') {
                const type = appState.currentView.charAt(0).toUpperCase() + appState.currentView.slice(1);
                const formId = `add${type}TransactionForm`, form = document.getElementById(formId);
                form.reset(); form.querySelector('[id*="Date"]').valueAsDate = new Date();
                populateAllAccountsDropdown(`${appState.currentView}TxAccount`);
                populateCategoriesDropdown(`${appState.currentView}TxCategory`);
                openModal(`add${type}TransactionModal`);
            }
        });

        function renderAccountsView() {
            viewContainer.innerHTML = `<div class="flex flex-wrap justify-between items-center gap-4 mb-6"><h2 class="text-3xl font-bold">My Accounts & Settings</h2><div class="flex items-center gap-4"><button onclick="openModal('manageCategoriesModal')" class="bg-theme-light/90 hover:bg-theme-light text-theme-dark font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i data-lucide="settings-2" class="w-4 h-4"></i> Manage Categories</button><button id="addAccountBtn" class="bg-theme-light hover:bg-theme-light/90 text-theme-dark font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i> Add Account</button></div></div><div id="accountsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div><p id="noAccountsMessage" class="hidden text-center text-theme-light/70 py-8">No accounts found.</p>`;
            renderAccountsList(); lucide.createIcons();
            document.getElementById('addAccountBtn').addEventListener('click', () => openModal('addAccountTypeModal'));
            renderCategoryList();
        }
        
        function renderTransactionList(elId, txs) {
            const el = document.getElementById(elId); if (!el) return;
            el.innerHTML = txs.length === 0 ? `<div class="glass-card p-8 text-center text-theme-light/70">No transactions yet.</div>` : txs.map(tx => { const isExpense = tx.type === 'expense', acc = appState.accounts.find(a => a.id === tx.accountId); return `<div class="glass-card p-4 flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-full flex items-center justify-center ${isExpense ? 'bg-red-500/10' : 'bg-green-500/10'}"><i data-lucide="${isExpense ? 'arrow-down' : 'arrow-up'}" class="w-5 h-5 ${isExpense ? 'text-red-400' : 'text-green-400'}"></i></div><div><p class="font-semibold">${tx.description||tx.category}</p><p class="text-sm text-theme-light/70">${new Date(tx.date).toLocaleDateString()} &bull; ${acc ? acc.name : 'Unknown'}</p></div></div><p class="font-bold text-lg ${isExpense ? 'text-red-400' : 'text-green-400'}">${isExpense ? '-' : '+'}₹${tx.amount.toFixed(2)}</p></div>`; }).join('');
            lucide.createIcons();
        }

        function renderAccountsList() {
            const listEl = document.getElementById('accountsList'), msgEl = document.getElementById('noAccountsMessage');
            if (appState.accounts.length === 0) { listEl.classList.add('hidden'); msgEl.classList.remove('hidden'); return; }
            listEl.classList.remove('hidden'); msgEl.classList.add('hidden');
            const icons = {'Bank':'landmark','Credit Card':'credit-card','Debit Card':'credit-card','Wallet':'wallet','UPI':'zap','Cash':'banknote'};
            listEl.innerHTML = appState.accounts.map(acc => `<div class="glass-card p-6 flex flex-col justify-between"><div><div class="flex justify-between items-start"><span class="text-sm text-theme-light/70">${acc.type}</span><div class="flex items-center gap-2"><button class="text-theme-light/70 hover:text-theme-light"><i data-lucide="pencil" class="w-4 h-4"></i></button><i data-lucide="${icons[acc.type]||'dollar-sign'}" class="w-5 h-5 text-theme-light/70"></i></div></div><p class="text-xl font-semibold mt-1">${acc.name}</p></div><p class="text-3xl font-bold mt-4">₹${(acc.balance || 0).toFixed(2)}</p></div>`).join('');
            lucide.createIcons();
        }

        function createCategoryDoughnutChart(id, txs) {
            const canvas = document.getElementById(id); if (!canvas) return;
            const data = txs.filter(t=>t.type==='expense').reduce((a, t) => { a[t.category]=(a[t.category]||0)+t.amount; return a; }, {});
            if (charts[id]) charts[id].destroy();
            const noData = canvas.parentNode.querySelector('.no-data-msg'); if (noData) noData.remove();
            if (Object.keys(data).length === 0) { canvas.style.display='none'; canvas.insertAdjacentHTML('afterend', `<div class="no-data-msg text-center text-theme-light/70 py-10">No expense data.</div>`); return; }
            canvas.style.display = 'block';
            charts[id] = new Chart(canvas.getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#fbf8BE','#D9D7A0','#A6A473','#73725A','#595842'], borderColor: '#234E70' }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: '#fbf8BE' } } } } });
        }
        
        window.openModal = (id) => { const el=document.getElementById(id); el.style.display='flex'; setTimeout(()=>el.querySelector('.glass-card').style.opacity='1', 50); lucide.createIcons(); };
        window.closeModal = (id) => { const el=document.getElementById(id); el.querySelector('.glass-card').style.opacity='0'; setTimeout(()=>el.style.display='none', 300); };
        
        window.selectAccountType = (type) => {
            if (['Credit Card', 'Debit Card', 'Wallet', 'UPI'].includes(type) && !appState.accounts.some(a=>a.type==='Bank')) { showToast("Add a bank account first.", "warning"); return; }
            closeModal('addAccountTypeModal');
            setTimeout(() => {
                const modalId = `add${type.replace(' ','')}Modal`;
                const form = document.getElementById(modalId.replace('Modal', 'Form')); if (form) form.reset();
                if (type.includes('Card') || type === 'Wallet' || type === 'UPI') populateBankAccountsDropdown(`${type.toLowerCase().replace(' ','')}LinkedBank`);
                openModal(modalId);
            }, 200);
        };
        
        const txFormHandler = async (e, type) => {
            e.preventDefault(); loadingIndicator.style.display = 'flex';
            const form = e.target, data = { date: form.querySelector('[id*="Date"]').value, type: form.querySelector('[id*="Type"]').value, accountId: form.querySelector('[id*="Account"]').value, category: form.querySelector('[id*="Category"]').value, amount: parseFloat(form.querySelector('[id*="Amount"]').value), description: form.querySelector('[id*="Description"]').value, createdAt: new Date().toISOString() };
            try {
                const batch = writeBatch(db);
                batch.set(doc(collection(db, `users/${userId}/${type}Transactions`)), data);
                batch.update(doc(db, `users/${userId}/accounts`, data.accountId), { balance: increment(data.type === 'income' ? data.amount : -data.amount) });
                await batch.commit();
                showToast("Transaction saved!", "success");
                closeModal(`add${type.charAt(0).toUpperCase() + type.slice(1)}TransactionModal`);
            } catch (err) { console.error(err); showToast("Failed to save transaction.", "error"); }
            finally { loadingIndicator.style.display = 'none'; }
        };
        document.getElementById('addPersonalTransactionForm').addEventListener('submit', (e) => txFormHandler(e, 'personal'));
        document.getElementById('addHomeTransactionForm').addEventListener('submit', (e) => txFormHandler(e, 'home'));

        const accountFormHandler = async (e, type) => {
            e.preventDefault(); loadingIndicator.style.display = 'flex';
            const form = e.target, data = { type };
            new FormData(form).forEach((val, key) => data[key] = isNaN(val) || val === '' ? val : parseFloat(val));
            data.createdAt = new Date().toISOString();
            try {
                await addDoc(collection(db, `users/${userId}/accounts`), data);
                showToast("Account added!", "success");
                closeModal(`add${type.replace(' ','')}Modal`);
            } catch(err) { console.error(err); showToast("Failed to add account.", "error"); }
            finally { loadingIndicator.style.display = 'none'; }
        };
        ['Bank', 'Credit Card', 'Debit Card', 'Wallet', 'UPI', 'Cash'].forEach(type => {
            const formId = `add${type.replace(' ','')}Form`;
            const form = document.getElementById(formId);
            if (form) form.addEventListener('submit', (e) => accountFormHandler(e, type));
        });

        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCat = document.getElementById('newCategoryName').value.trim();
            if (newCat && !appState.categories.includes(newCat)) {
                await setDoc(doc(db, `users/${userId}/appData/categories`), { list: [...appState.categories, newCat] });
                showToast("Category added!", "success");
                document.getElementById('newCategoryName').value = '';
            }
        });

        function renderCategoryList() {
            const listEl = document.getElementById('categoryList'); if (!listEl) return;
            listEl.innerHTML = appState.categories.map(cat => `<div class="flex justify-between items-center bg-theme-light/5 p-2 rounded-lg"><span>${cat}</span><button class="text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('');
            lucide.createIcons();
        }

        function populateAllAccountsDropdown(id) {
            const sel = document.getElementById(id); if(!sel) return;
            sel.innerHTML = '<option value="">Select Account</option>' + appState.accounts.filter(a => typeof a.balance === 'number').map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        }
        function populateBankAccountsDropdown(id) {
            const sel = document.getElementById(id); if(!sel) return;
            sel.innerHTML = '<option value="">Select Bank</option>' + appState.accounts.filter(a => a.type === 'Bank').map(a => `<option value="${a.name}">${a.name}</option>`).join('');
        }
        function populateCategoriesDropdown(id) {
            const sel = document.getElementById(id); if(!sel) return;
            sel.innerHTML = '<option value="">Select Category</option>' + appState.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        
        function showToast(message, type = 'success') {
            const cont = document.getElementById('toastContainer');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500 text-theme-dark' };
            const toast = document.createElement('div');
            toast.className = `toast text-white p-4 rounded-lg shadow-lg mb-2 ${colors[type]}`;
            toast.textContent = message;
            cont.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        initialize();
    </script>
</body>
</html>


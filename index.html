<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal & Home Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font Link -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'theme-dark': '#234E70',
                        'theme-light': '#fbf8BE',
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            background-color: #234E70; /* Theme Dark */
            color: #fbf8BE; /* Theme Light */
        }
        .glass-card {
            background: rgba(251, 248, 190, 0.05);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 12px;
            border: 1px solid rgba(251, 248, 190, 0.15);
        }
        .modal-backdrop {
            background: rgba(35, 78, 112, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .nav-button { transition: all 0.3s ease; position: relative; }
        .nav-button.active { color: #fbf8BE; font-weight: 600; }
        .nav-button.active::after { content: ''; position: absolute; bottom: -4px; left: 0; right: 0; height: 2px; background-color: #fbf8BE; border-radius: 1px; }
        .toast { animation: slideInRight 0.5s ease-out, fadeOut 0.5s ease-in 2.5s; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .account-type-card { transition: all 0.2s ease-in-out; }
        .account-type-card:hover { transform: translateY(-5px); background: rgba(251, 248, 190, 0.1); }
        input, select { color-scheme: dark; }
        .text-theme-dark { color: #234E70; }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .form-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #fbf8BE;
        }
    </style>
</head>
<body class="antialiased bg-theme-dark text-theme-light">

    <!-- Login View -->
    <div id="loginView" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <div class="glass-card p-10 max-w-md w-full">
            <i data-lucide="wallet" class="w-16 h-16 text-theme-light mx-auto mb-4"></i>
            <h1 class="text-3xl font-bold text-theme-light mb-2">Expense Tracker</h1>
            <p class="text-theme-light/70 mb-8">Sign in to access your synced finances.</p>
            <button id="signInBtn" class="w-full flex items-center justify-center gap-3 bg-theme-light text-theme-dark font-semibold py-3 px-6 rounded-lg hover:bg-theme-light/90 transition-all">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Sign In with Google
            </button>
        </div>
    </div>

    <!-- Main App View (Initially Hidden) -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <header class="flex items-center justify-between mb-8 gap-4">
            <!-- Left: App Title -->
            <div class="flex items-center gap-2">
                <i data-lucide="wallet" class="w-8 h-8 text-theme-light"></i>
                <h1 class="text-xl md:text-2xl font-bold text-theme-light hidden sm:block">ExpenseTracker</h1>
            </div>

            <!-- Center: Main Navigation -->
            <nav class="glass-card p-2 rounded-full">
                <div id="mainNav" class="flex items-center gap-2">
                    <button onclick="switchView('personal')" data-view="personal" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-theme-light/80">Personal</button>
                    <button onclick="switchView('home')" data-view="home" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-theme-light/80">Home</button>
                </div>
            </nav>

            <!-- Right: Profile & Settings Dropdown -->
            <div class="flex items-center justify-end">
                <div id="totalBalance" class="text-right mr-6 hidden lg:block">
                     <!-- Total balance injected here -->
                </div>
                <div class="relative">
                    <button id="profileDropdownBtn" class="flex items-center gap-3 cursor-pointer">
                        <!-- User profile image will be injected here -->
                    </button>
                    <div id="profileDropdownMenu" class="absolute right-0 mt-3 w-60 glass-card rounded-xl shadow-lg z-50 hidden transition-opacity duration-300" style="padding: 0.5rem;">
                        <div id="userProfileInfo" class="p-2 border-b border-theme-light/10 mb-2 flex items-center gap-3">
                            <!-- User full info will be injected here -->
                        </div>
                        <div class="space-y-1">
                            <a href="#" id="manageAccountsBtn" class="flex items-center gap-3 w-full text-left px-3 py-2 text-sm text-theme-light/80 hover:bg-theme-light/10 rounded-md">
                                <i data-lucide="landmark" class="w-4 h-4"></i> Manage Accounts
                            </a>
                            <a href="#" onclick="openModal('addAccountTypeModal'); document.getElementById('profileDropdownMenu').classList.add('hidden');" class="flex items-center gap-3 w-full text-left px-3 py-2 text-sm text-theme-light/80 hover:bg-theme-light/10 rounded-md">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Account
                            </a>
                            <a href="#" onclick="openModal('manageCategoriesModal'); document.getElementById('profileDropdownMenu').classList.add('hidden');" class="flex items-center gap-3 w-full text-left px-3 py-2 text-sm text-theme-light/80 hover:bg-theme-light/10 rounded-md">
                               <i data-lucide="settings-2" class="w-4 h-4"></i> Manage Categories
                            </a>
                            <div class="border-t border-theme-light/10 !mt-2 pt-2">
                                 <a href="#" id="signOutBtnDropdown" class="flex items-center gap-3 w-full text-left px-3 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-md">
                                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <main id="viewContainer"></main>
    </div>
    
    <!-- ALL MODALS -->
    <div id="addPersonalTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addPersonalTransactionModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addPersonalTransactionModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-theme-light mb-6">Add Personal Transaction</h2><form id="addPersonalTransactionForm" class="space-y-4"><div><label for="personalTxDate" class="block text-xs font-medium text-theme-light/70 mb-1">Date</label><input type="date" id="personalTxDate" class="form-input" required></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="personalTxType" class="block text-xs font-medium text-theme-light/70 mb-1">Type</label><select id="personalTxType" class="form-input" required><option value="expense">Expense</option><option value="income">Income</option></select></div><div><label for="personalTxAccount" class="block text-xs font-medium text-theme-light/70 mb-1">Account</label><select id="personalTxAccount" class="form-input" required></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="personalTxCategory" class="block text-xs font-medium text-theme-light/70 mb-1">Category</label><select id="personalTxCategory" class="form-input" required></select></div><div><label for="personalTxAmount" class="block text-xs font-medium text-theme-light/70 mb-1">Amount</label><input type="number" id="personalTxAmount" placeholder="0.00" step="0.01" class="form-input" required></div></div><div><label for="personalTxDescription" class="block text-xs font-medium text-theme-light/70 mb-1">Description</label><input type="text" id="personalTxDescription" placeholder="e.g., Lunch" class="form-input" required></div><button type="submit" class="w-full p-4 bg-theme-light text-theme-dark font-bold rounded-lg hover:bg-theme-light/90">Save Transaction</button></form></div></div>
    <div id="addHomeTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addHomeTransactionModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addHomeTransactionModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-theme-light mb-6">Add Home Transaction</h2><form id="addHomeTransactionForm" class="space-y-4"><div><label for="homeTxDate" class="block text-xs font-medium text-theme-light/70 mb-1">Date</label><input type="date" id="homeTxDate" class="form-input" required></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="homeTxType" class="block text-xs font-medium text-theme-light/70 mb-1">Type</label><select id="homeTxType" class="form-input" required><option value="expense">Expense</option><option value="income">Income</option></select></div><div><label for="homeTxAccount" class="block text-xs font-medium text-theme-light/70 mb-1">Account</label><select id="homeTxAccount" class="form-input" required></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="homeTxCategory" class="block text-xs font-medium text-theme-light/70 mb-1">Category</label><select id="homeTxCategory" class="form-input" required></select></div><div><label for="homeTxAmount" class="block text-xs font-medium text-theme-light/70 mb-1">Amount</label><input type="number" id="homeTxAmount" placeholder="0.00" step="0.01" class="form-input" required></div></div><div><label for="homeTxDescription" class="block text-xs font-medium text-theme-light/70 mb-1">Description</label><input type="text" id="homeTxDescription" placeholder="e.g., Groceries" class="form-input" required></div><button type="submit" class="w-full p-4 bg-theme-light text-theme-dark font-bold rounded-lg hover:bg-theme-light/90">Save Transaction</button></form></div></div>
    <div id="addAccountTypeModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addAccountTypeModal')"></div><div class="glass-card w-full max-w-2xl m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('addAccountTypeModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold text-center mb-6">Select Account Type</h2><div class="grid grid-cols-2 md:grid-cols-3 gap-4"><button onclick="selectAccountType('Bank')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="landmark" class="w-8 h-8"></i><span>Bank</span></button><button onclick="selectAccountType('Credit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="credit-card" class="w-8 h-8"></i><span>Credit Card</span></button><button onclick="selectAccountType('Debit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="credit-card" class="w-8 h-8"></i><span>Debit Card</span></button><button onclick="selectAccountType('Wallet')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="wallet" class="w-8 h-8"></i><span>Wallet</span></button><button onclick="selectAccountType('UPI')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="zap" class="w-8 h-8"></i><span>UPI</span></button><button onclick="selectAccountType('Cash')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg"><i data-lucide="banknote" class="w-8 h-8"></i><span>Cash</span></button></div></div></div>
    <div id="manageCategoriesModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('manageCategoriesModal')"></div><div class="glass-card w-full max-w-md m-4 p-8 relative transform transition-all" style="opacity:0;transform:scale(.95)"><button onclick="closeModal('manageCategoriesModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Manage Categories</h2><form id="addCategoryForm" class="flex gap-2 mb-4"><input type="text" id="newCategoryName" placeholder="New category name" class="form-input flex-grow" required><button type="submit" class="p-3 bg-theme-light text-theme-dark rounded-lg hover:bg-theme-light/90"><i data-lucide="plus" class="w-6 h-6"></i></button></form><div id="categoryList" class="space-y-2 max-h-60 overflow-y-auto"></div></div></div>
    
    <!-- Add Bank Account Modal -->
    <div id="addBankModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addBankModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addBankModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add Bank Account</h2><form id="addBankForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Account Nickname</label><input type="text" name="name" placeholder="e.g., My Savings" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Initial Balance</label><input type="number" name="balance" placeholder="0.00" step="0.01" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" placeholder="e.g., State Bank of India" class="form-input"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Account Number</label><input type="text" name="accountNumber" placeholder="Last 6 digits" class="form-input"></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">IFSC Code</label><input type="text" name="ifscCode" placeholder="e.g., SBIN0001234" class="form-input"></div></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Branch Name</label><input type="text" name="branchName" placeholder="e.g., Main Branch" class="form-input"></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Account</button></form></div></div>
    
    <!-- Add/Edit Modals (kept separate for simplicity) -->
    <div id="addCreditCardModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addCreditCardModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addCreditCardModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add Credit Card</h2><form id="addCreditCardForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Card Nickname</label><input type="text" name="name" placeholder="e.g., HDFC Millennia" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" placeholder="e.g., HDFC Bank" class="form-input" required></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Last 4 Digits</label><input type="number" name="lastFour" placeholder="1234" class="form-input"></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Credit Limit</label><input type="number" name="creditLimit" placeholder="50000" step="100" class="form-input"></div></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank Account</label><select name="linkedBank" id="creditcardLinkedBank" class="form-input" required></select></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Credit Card</button></form></div></div>
    <div id="addDebitCardModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addDebitCardModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addDebitCardModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add Debit Card</h2><form id="addDebitCardForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Card Nickname</label><input type="text" name="name" placeholder="e.g., SBI Global" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Bank Name</label><input type="text" name="bankName" placeholder="e.g., State Bank of India" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Last 4 Digits</label><input type="number" name="lastFour" placeholder="1234" class="form-input"></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank Account</label><select name="linkedBank" id="debitcardLinkedBank" class="form-input" required></select></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Debit Card</button></form></div></div>
    <div id="addWalletModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addWalletModal')"></div><div class="glass-card w-full max-w-sm m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addWalletModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add Wallet</h2><form id="addWalletForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Wallet Name</label><input type="text" name="name" placeholder="e.g., Paytm" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Initial Balance</label><input type="number" name="balance" placeholder="0.00" step="0.01" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank Account (Optional)</label><select name="linkedBank" id="walletLinkedBank" class="form-input"></select></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Wallet</button></form></div></div>
    <div id="addUpiModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addUpiModal')"></div><div class="glass-card w-full max-w-sm m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addUpiModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add UPI App</h2><form id="addUpiForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">UPI App Name</label><input type="text" name="name" placeholder="e.g., Google Pay" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">UPI ID (Optional)</label><input type="text" name="upiId" placeholder="yourname@bank" class="form-input"></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Linked Bank Account</label><select name="linkedBank" id="upiLinkedBank" class="form-input" required></select></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save UPI</button></form></div></div>
    <div id="addCashModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('addCashModal')"></div><div class="glass-card w-full max-w-sm m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('addCashModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 class="text-2xl font-bold mb-6">Add Cash Account</h2><form id="addCashForm" class="space-y-4"><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Nickname</label><input type="text" name="name" placeholder="e.g., Cash in Hand" class="form-input" required></div><div><label class="block text-xs font-medium text-theme-light/70 mb-1">Initial Balance</label><input type="number" name="balance" placeholder="0.00" step="0.01" class="form-input" required></div><button type="submit" class="w-full p-4 mt-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Cash</button></form></div></div>
    
    <!-- Universal Edit Account Modal -->
    <div id="editAccountModal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop absolute inset-0" onclick="closeModal('editAccountModal')"></div><div class="glass-card w-full max-w-lg m-4 p-8 relative" style="opacity:0; transform:scale(.95);"><button onclick="closeModal('editAccountModal')" class="absolute top-4 right-4 text-theme-light/70 hover:text-theme-light"><i data-lucide="x" class="w-6 h-6"></i></button><h2 id="editAccountTitle" class="text-2xl font-bold mb-6">Edit Account</h2><form id="editAccountForm" class="space-y-4"><div id="editAccountFields" class="space-y-4"></div><button type="submit" class="w-full p-4 mt-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all">Update Account</button></form></div></div>

    <div id="loadingIndicator" class="fixed inset-0 z-[101] items-center justify-center hidden bg-black/50"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-theme-light"></div></div>
    <div id="toastContainer" class="fixed top-5 right-5 z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            // Your Firebase config details here
             apiKey: "AIzaSyCIYq9g1bCcx82Naieth_-dCo0h154VMo8",
             authDomain: "myexpensetracker-a9118.firebaseapp.com",
             projectId: "myexpensetracker-a9118",
             storageBucket: "myexpensetracker-a9118.appspot.com",
             messagingSenderId: "172584825601",
             appId: "1:172584825601:web:456c446a4ecdab2faa2100",
             measurementId: "G-HQ4FWR8RKH"
        };

        let db, auth, userId, appState = { accounts: [], personalTransactions: [], homeTransactions: [], categories: [], currentView: 'personal' }, charts = {};
        const loginView = document.getElementById('loginView'), appView = document.getElementById('app'), viewContainer = document.getElementById('viewContainer'), loadingIndicator = document.getElementById('loadingIndicator'), mainNav = document.getElementById('mainNav'), signInBtn = document.getElementById('signInBtn');

        function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loginView.classList.add('hidden');
                        appView.classList.remove('hidden');
                        displayUserProfile(user);
                        fetchInitialData();
                        setupEventListeners();
                        switchView('personal');
                    } else {
                        userId = null;
                        loginView.classList.remove('hidden');
                        appView.classList.add('hidden');
                        Object.values(charts).forEach(c => c.destroy());
                        charts = {};
                    }
                });
            } catch (err) { console.error("Firebase init error: ", err); showToast("Error connecting to Firebase.", "error"); }
        }

        let eventListenersInitialized = false;
        function setupEventListeners() {
            if(eventListenersInitialized) return;

            const profileDropdownBtn = document.getElementById('profileDropdownBtn');
            const profileDropdownMenu = document.getElementById('profileDropdownMenu');

            profileDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdownMenu.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                // Close dropdown if clicked outside
                if (!profileDropdownBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                    profileDropdownMenu.classList.add('hidden');
                }
                
                // Dropdown menu actions
                const manageAccountsBtn = e.target.closest('#manageAccountsBtn');
                if (manageAccountsBtn) {
                    e.preventDefault();
                    switchView('accounts');
                    profileDropdownMenu.classList.add('hidden');
                }
                const signOutBtnDropdown = e.target.closest('#signOutBtnDropdown');
                if (signOutBtnDropdown) {
                    e.preventDefault();
                    signOut(auth);
                }
            });

            signInBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error(error); showToast("Failed to sign in.", "error"); } });

            eventListenersInitialized = true;
        }

        function displayUserProfile(user) { 
            const profileDropdownBtn = document.getElementById('profileDropdownBtn');
            const userProfileInfo = document.getElementById('userProfileInfo');
            profileDropdownBtn.innerHTML = `<img src="${user.photoURL}" alt="User" class="w-10 h-10 rounded-full border-2 border-theme-light/30">`;
            userProfileInfo.innerHTML = `
                <img src="${user.photoURL}" alt="User" class="w-10 h-10 rounded-full">
                <div>
                    <p class="font-semibold text-sm truncate">${user.displayName}</p>
                    <p class="text-xs text-theme-light/70 truncate">${user.email}</p>
                </div>
            `;
        }

        function fetchInitialData() {
            if (!userId) return;
            onSnapshot(collection(db, `users/${userId}/accounts`), s => { 
                appState.accounts = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                renderTotalBalance();
                if(appState.currentView) switchView(appState.currentView); 
            }, e => showToast(`Could not fetch accounts.`, 'error'));

            ['personalTransactions', 'homeTransactions'].forEach(coll => {
                 onSnapshot(collection(db, `users/${userId}/${coll}`), s => { 
                    appState[coll] = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                    if(appState.currentView === coll.replace('Transactions', '')) switchView(appState.currentView);
                }, e => showToast(`Could not fetch ${coll}.`, 'error'));
            });
            onSnapshot(doc(db, `users/${userId}/appData/categories`), (docSnap) => {
                if (docSnap.exists() && docSnap.data().list) { appState.categories = docSnap.data().list; }
                else { const d = ["Food","Transport","Bills","Shopping","Health","Other"]; setDoc(doc(db, `users/${userId}/appData/categories`),{list:d}); appState.categories=d; }
            });
        }

        function renderTotalBalance() {
            const totalBalanceEl = document.getElementById('totalBalance');
            if (!totalBalanceEl) return;
            const totalBalance = appState.accounts
                .filter(acc => typeof acc.balance === 'number')
                .reduce((sum, acc) => sum + acc.balance, 0);
            totalBalanceEl.innerHTML = `<p class="text-sm text-theme-light/70">Total Balance</p><p class="text-2xl font-bold">₹${totalBalance.toFixed(2)}</p>`;
        }
        
        window.switchView = (v) => {
            appState.currentView = v;
            mainNav.querySelectorAll('.nav-button').forEach(b => b.classList.toggle('active', b.dataset.view === v));
            if (v === 'accounts') {
                mainNav.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            }
            const renders = { personal: renderPersonalView, home: renderHomeView, accounts: renderAccountsView };
            if (renders[v]) renders[v]();
        };
        
        const renderSummaryAndChart = (view, txs) => {
            const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0), expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            viewContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Balance</h3><p class="text-3xl font-bold mt-2">₹${(income - expense).toFixed(2)}</p></div><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Income</h3><p class="text-3xl font-bold text-green-400 mt-2">₹${income.toFixed(2)}</p></div><div class="glass-card p-6"><h3 class="text-sm font-medium text-theme-light/70">${view} Expense</h3><p class="text-3xl font-bold text-red-400 mt-2">₹${expense.toFixed(2)}</p></div></div><div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-3"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Recent Transactions</h2><button id="addTxBtn" class="bg-theme-light hover:bg-theme-light/90 text-theme-dark font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5"></i> Add</button></div><div id="txList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div></div><div class="lg:col-span-2 glass-card p-6"><h3 class="text-lg font-semibold mb-4">Spending by Category</h3><canvas id="spendingChart"></canvas></div></div>`;
            renderTransactionList('txList', txs); createCategoryDoughnutChart('spendingChart', txs);
        };

        const renderPersonalView = () => renderSummaryAndChart('Personal', appState.personalTransactions);
        const renderHomeView = () => renderSummaryAndChart('Home', appState.homeTransactions);

        document.addEventListener('click', (e) => {
            const addTxBtn = e.target.closest('#addTxBtn');
            if (addTxBtn) {
                const type = appState.currentView.charAt(0).toUpperCase() + appState.currentView.slice(1);
                const formId = `add${type}TransactionForm`, form = document.getElementById(formId);
                form.reset(); form.querySelector('[id*="Date"]').valueAsDate = new Date();
                populateAllAccountsDropdown(form.querySelector('[id*="Account"]').id);
                populateCategoriesDropdown(form.querySelector('[id*="Category"]').id);
                openModal(`add${type}TransactionModal`);
            }
        });

        function renderAccountsView() {
            viewContainer.innerHTML = `<div class="flex flex-wrap justify-between items-center gap-4 mb-6"><h2 class="text-3xl font-bold">My Accounts</h2></div><div id="accountsList" class="space-y-8"></div><p id="noAccountsMessage" class="hidden text-center text-theme-light/70 py-8">No accounts found. Use the profile menu to add an account.</p>`;
            renderAccountsList();
        }
        
        function renderTransactionList(elId, txs) {
            const el = document.getElementById(elId); if (!el) return;
            el.innerHTML = txs.length === 0 ? `<div class="glass-card p-8 text-center text-theme-light/70">No transactions yet.</div>` : txs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(tx => { 
                const isExpense = tx.type === 'expense';
                const acc = appState.accounts.find(a => a.id === tx.accountId); 
                return `<div class="glass-card p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${isExpense ? 'bg-red-500/10' : 'bg-green-500/10'}">
                            <i data-lucide="${isExpense ? 'arrow-down' : 'arrow-up'}" class="w-5 h-5 ${isExpense ? 'text-red-400' : 'text-green-400'}"></i>
                        </div>
                        <div>
                            <p class="font-semibold">${tx.description||tx.category}</p>
                            <p class="text-sm text-theme-light/70">${new Date(tx.date).toLocaleDateString()} &bull; ${acc ? acc.name : 'Unknown'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="font-bold text-lg ${isExpense ? 'text-red-400' : 'text-green-400'}">${isExpense ? '-' : '+'}₹${tx.amount.toFixed(2)}</p>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditTransactionModal('${tx.id}', '${appState.currentView}')" class="text-theme-light/60 hover:text-theme-light p-1"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button onclick="deleteTransaction('${tx.id}', '${appState.currentView}')" class="text-theme-light/60 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>`; 
            }).join('');
            lucide.createIcons();
        }

        function renderAccountsList() {
            const listEl = document.getElementById('accountsList'), msgEl = document.getElementById('noAccountsMessage');
            if (!listEl || !msgEl) return;
            if (appState.accounts.length === 0) { listEl.innerHTML = ''; msgEl.classList.remove('hidden'); return; }
            listEl.innerHTML = ''; msgEl.classList.add('hidden');

            const groupedAccounts = appState.accounts.reduce((groups, acc) => {
                const type = acc.type || 'Other';
                if (!groups[type]) {
                    groups[type] = [];
                }
                groups[type].push(acc);
                return groups;
            }, {});

            const accountOrder = ['Bank', 'Credit Card', 'Debit Card', 'Wallet', 'UPI', 'Cash'];
            const typeIcons = {
                'Bank': 'landmark',
                'Credit Card': 'credit-card',
                'Debit Card': 'credit-card',
                'Wallet': 'wallet',
                'UPI': 'zap',
                'Cash': 'banknote'
            };

            accountOrder.forEach(type => {
                if (groupedAccounts[type]) {
                    const accountsOfType = groupedAccounts[type];
                    const sectionWrapper = document.createElement('div');
                    
                    const sectionTitle = document.createElement('h3');
                    sectionTitle.className = "text-xl font-semibold mb-4 border-b border-theme-light/20 pb-2 flex items-center gap-3";
                    sectionTitle.innerHTML = `<i data-lucide="${typeIcons[type] || 'help-circle'}" class="w-6 h-6 text-theme-light/80"></i> <span>${type} Accounts</span>`;
                    
                    const gridContainer = document.createElement('div');
                    gridContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";

                    gridContainer.innerHTML = accountsOfType.map(acc => {
                         let details = '';
                        let balanceDisplayHtml = '';

                        if (acc.type === 'Bank' && acc.bankName) {
                            details = `<p class="text-sm text-theme-light/60 mt-1">${acc.bankName}</p>`;
                        } else if ((acc.type === 'Credit Card' || acc.type === 'Debit Card') && acc.lastFour) {
                            details = `<p class="text-sm text-theme-light/60 mt-1">${acc.bankName || ''} &bull; **** ${acc.lastFour}</p>`;
                        } else if (acc.type === 'UPI' && acc.upiId){
                            details = `<p class="text-sm text-theme-light/60 mt-1">${acc.upiId}</p>`;
                        }

                        if (acc.type === 'Credit Card') {
                            balanceDisplayHtml = `<p class="text-lg mt-4"><span class="text-sm text-theme-light/70">Limit:</span> ₹${(acc.creditLimit || 0).toFixed(2)}</p>`;
                        } else if (acc.type === 'Debit Card' || acc.type === 'UPI') {
                            const linkedBank = appState.accounts.find(b => b.type === 'Bank' && b.name === acc.linkedBank);
                            const linkedBalance = linkedBank ? linkedBank.balance : 0;
                            balanceDisplayHtml = `<p class="text-3xl font-bold mt-4">₹${(linkedBalance || 0).toFixed(2)}</p><p class="text-xs text-theme-light/60">From ${acc.linkedBank}</p>`;
                        } else {
                            balanceDisplayHtml = `<p class="text-3xl font-bold mt-4">₹${(acc.balance || 0).toFixed(2)}</p>`;
                        }

                        return `<div class="glass-card p-6 flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start">
                                    <span class="text-sm text-theme-light/70">${acc.type}</span>
                                    <div class="flex items-center gap-3">
                                        <button onclick="openEditAccountModal('${acc.id}')" class="text-theme-light/70 hover:text-theme-light"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        <button onclick="deleteAccount('${acc.id}')" class="text-theme-light/70 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <p class="text-xl font-semibold mt-1">${acc.name}</p>
                                ${details}
                            </div>
                            ${balanceDisplayHtml}
                        </div>`;
                    }).join('');
                    
                    sectionWrapper.appendChild(sectionTitle);
                    sectionWrapper.appendChild(gridContainer);
                    listEl.appendChild(sectionWrapper);
                }
            });
            lucide.createIcons();
        }

        function createCategoryDoughnutChart(id, txs) {
            const canvas = document.getElementById(id); if (!canvas) return;
            const data = txs.filter(t=>t.type==='expense').reduce((a, t) => { a[t.category]=(a[t.category]||0)+t.amount; return a; }, {});
            if (charts[id]) charts[id].destroy();
            const noData = canvas.parentNode.querySelector('.no-data-msg'); if (noData) noData.remove();
            if (Object.keys(data).length === 0) { canvas.style.display='none'; canvas.insertAdjacentHTML('afterend', `<div class="no-data-msg text-center text-theme-light/70 py-10">No expense data.</div>`); return; }
            canvas.style.display = 'block';
            charts[id] = new Chart(canvas.getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#fbf8BE','#D9D7A0','#A6A473','#73725A','#595842'], borderColor: '#234E70' }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: '#fbf8BE' } } } } });
        }
        
        window.openModal = (id) => { const el=document.getElementById(id); if(el) {el.style.display='flex'; setTimeout(()=>el.querySelector('.glass-card').style.opacity='1', 50); lucide.createIcons();} };
        window.closeModal = (id) => { const el=document.getElementById(id); if(el) { el.querySelector('.glass-card').style.opacity='0'; setTimeout(()=> { el.style.display='none'; const form = el.querySelector('form'); if(form) resetForm(form); }, 300); }};
        
        window.selectAccountType = (type) => {
            if (['Credit Card', 'Debit Card', 'Wallet', 'UPI'].includes(type) && !appState.accounts.some(a=>a.type==='Bank')) { showToast("Add a bank account first.", "warning"); return; }
            closeModal('addAccountTypeModal');
            setTimeout(() => {
                const modalId = `add${type.replace(/\s/g, '')}Modal`;
                if (type.includes('Card') || type === 'Wallet' || type === 'UPI') {
                    const linkedBankId = `${type.toLowerCase().replace(/\s/g, '')}LinkedBank`;
                    populateBankAccountsDropdown(linkedBankId);
                }
                openModal(modalId);
            }, 300);
        };
        
        const txFormHandler = async (e, type) => {
            e.preventDefault();
            loadingIndicator.style.display = 'flex';
            const form = e.target;
            const editId = form.dataset.editId;

            const data = {
                date: form.querySelector('[id*="Date"]').value,
                type: form.querySelector('[id*="Type"]').value,
                accountId: form.querySelector('[id*="Account"]').value,
                category: form.querySelector('[id*="Category"]').value,
                amount: parseFloat(form.querySelector('[id*="Amount"]').value),
                description: form.querySelector('[id*="Description"]').value,
            };

            try {
                const batch = writeBatch(db);

                if (editId) { // --- UPDATE LOGIC ---
                    data.updatedAt = serverTimestamp();
                    const originalTx = appState[`${type}Transactions`].find(t => t.id === editId);
                    if (!originalTx) throw new Error("Original transaction not found");

                    const txRef = doc(db, `users/${userId}/${type}Transactions`, editId);
                    batch.update(txRef, data);

                    const originalAmount = originalTx.type === 'expense' ? -originalTx.amount : originalTx.amount;
                    const newAmount = data.type === 'expense' ? -data.amount : data.amount;

                    if (originalTx.accountId === data.accountId) {
                        const balanceDifference = newAmount - originalAmount;
                        const accountRef = doc(db, `users/${userId}/accounts`, data.accountId);
                        batch.update(accountRef, { balance: increment(balanceDifference) });
                    } else {
                        const oldAccountRef = doc(db, `users/${userId}/accounts`, originalTx.accountId);
                        batch.update(oldAccountRef, { balance: increment(-originalAmount) });

                        const newAccountRef = doc(db, `users/${userId}/accounts`, data.accountId);
                        batch.update(newAccountRef, { balance: increment(newAmount) });
                    }
                    showToast("Transaction updated!", "success");

                } else { // --- CREATE LOGIC ---
                    data.createdAt = serverTimestamp();
                    const txRef = doc(collection(db, `users/${userId}/${type}Transactions`));
                    batch.set(txRef, data);
                    
                    const accountRef = doc(db, `users/${userId}/accounts`, data.accountId);
                    const balanceChange = data.type === 'income' ? data.amount : -data.amount;
                    batch.update(accountRef, { balance: increment(balanceChange) });
                    
                    showToast("Transaction saved!", "success");
                }

                await batch.commit();
                closeModal(`add${type.charAt(0).toUpperCase() + type.slice(1)}TransactionModal`);

            } catch (err) {
                console.error(err);
                showToast("Failed to save transaction.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        };
        document.getElementById('addPersonalTransactionForm').addEventListener('submit', (e) => txFormHandler(e, 'personal'));
        document.getElementById('addHomeTransactionForm').addEventListener('submit', (e) => txFormHandler(e, 'home'));

        const addAccountFormHandler = async (e) => {
            e.preventDefault();
            loadingIndicator.style.display = 'flex';
            const form = e.target;
            const accountType = form.dataset.accountType;
            
            const formData = new FormData(form);
            const data = { type: accountType };
            for (let [key, value] of formData.entries()) {
                if(value) data[key] = isNaN(value) || value === '' ? value : parseFloat(value);
            }
            data.createdAt = serverTimestamp();

            try {
                await addDoc(collection(db, `users/${userId}/accounts`), data);
                showToast("Account added!", "success");
                closeModal(`add${accountType.replace(/\s/g, '')}Modal`);
            } catch (err) {
                console.error("Add account failed: ", err);
                showToast("Failed to add account.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        };

        ['Bank', 'Credit Card', 'Debit Card', 'Wallet', 'UPI', 'Cash'].forEach(type => {
            const form = document.getElementById(`add${type.replace(/\s/g, '')}Form`);
            if (form) {
                form.dataset.accountType = type;
                form.addEventListener('submit', addAccountFormHandler);
            }
        });

        // --- EDIT ACCOUNT LOGIC ---
        const editAccountForm = document.getElementById('editAccountForm');
        window.openEditAccountModal = (accountId) => {
            const account = appState.accounts.find(a => a.id === accountId);
            if (!account) return;
            
            const fieldsContainer = document.getElementById('editAccountFields');
            fieldsContainer.innerHTML = ''; // Clear previous fields
            document.getElementById('editAccountTitle').textContent = `Edit ${account.type} Account`;
            editAccountForm.dataset.accountId = accountId;
            editAccountForm.dataset.accountType = account.type;

            const fields = getAccountFields(account.type);
            fieldsContainer.innerHTML = fields.map(field => {
                if (field.type === 'select') {
                    return `<div>
                        <label class="block text-xs font-medium text-theme-light/70 mb-1">${field.label}</label>
                        <select name="${field.name}" class="form-input" ${field.required ? 'required' : ''}></select>
                    </div>`;
                }
                return `<div>
                    <label class="block text-xs font-medium text-theme-light/70 mb-1">${field.label}</label>
                    <input type="${field.type || 'text'}" name="${field.name}" placeholder="${field.placeholder || ''}" class="form-input" value="${account[field.name] || ''}" ${field.required ? 'required' : ''} ${field.props || ''}>
                </div>`;
            }).join('');
            
            if(account.type.includes('Card') || account.type === 'Wallet' || account.type === 'UPI'){
                const selectEl = fieldsContainer.querySelector('select[name="linkedBank"]');
                populateBankAccountsDropdown(null, account.linkedBank, selectEl);
            }
            openModal('editAccountModal');
        };

        editAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingIndicator.style.display = 'flex';
            
            const accountId = e.target.dataset.accountId;
            const accountType = e.target.dataset.accountType;
            if (!accountId || !accountType) return;

            const formData = new FormData(e.target);
            const dataToUpdate = { type: accountType };
            const allFields = getAccountFields(accountType).map(f => f.name);

            allFields.forEach(fieldName => {
                const value = formData.get(fieldName);
                const isNumeric = ['balance', 'lastFour', 'creditLimit'].includes(fieldName);
                 if (value !== null && value !== undefined) {
                    dataToUpdate[fieldName] = isNumeric && value !== '' ? parseFloat(value) : value;
                } else {
                    dataToUpdate[fieldName] = '';
                }
            });

            try {
                await updateDoc(doc(db, `users/${userId}/accounts`, accountId), dataToUpdate);
                showToast("Account updated successfully!", "success");
                closeModal('editAccountModal');
            } catch (err) {
                console.error("Update failed: ", err);
                showToast("Failed to update account.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        function getAccountFields(type) {
            const baseFields = [ { name: 'name', label: 'Nickname', required: true } ];
            switch (type) {
                case 'Bank': return [...baseFields, { name: 'balance', label: 'Balance', type: 'number', props: 'step="0.01"', required: true }, { name: 'bankName', label: 'Bank Name'}, { name: 'accountNumber', label: 'Account Number'}, { name: 'ifscCode', label: 'IFSC Code'}, { name: 'branchName', label: 'Branch Name'}];
                case 'Credit Card': return [...baseFields, { name: 'bankName', label: 'Bank Name', required: true }, { name: 'lastFour', label: 'Last 4 Digits', type: 'number' }, { name: 'creditLimit', label: 'Credit Limit', type: 'number' }, { name: 'linkedBank', label: 'Linked Bank', type: 'select', required: true }];
                case 'Debit Card': return [...baseFields, { name: 'bankName', label: 'Bank Name', required: true }, { name: 'lastFour', label: 'Last 4 Digits', type: 'number' }, { name: 'linkedBank', label: 'Linked Bank', type: 'select', required: true }];
                case 'Wallet': return [...baseFields, { name: 'balance', label: 'Balance', type: 'number', props: 'step="0.01"', required: true }, { name: 'linkedBank', label: 'Linked Bank', type: 'select' }];
                case 'UPI': return [...baseFields, { name: 'upiId', label: 'UPI ID' }, { name: 'linkedBank', label: 'Linked Bank', type: 'select', required: true }];
                case 'Cash': return [...baseFields, { name: 'balance', label: 'Balance', type: 'number', props: 'step="0.01"', required: true }];
                default: return baseFields;
            }
        }
        
        window.deleteAccount = async (accountId) => {
             if (!confirm("Are you sure you want to delete this account? This cannot be undone.")) return;
            loadingIndicator.style.display = 'flex';
            try {
                await deleteDoc(doc(db, `users/${userId}/accounts`, accountId));
                showToast("Account deleted.", "success");
            } catch (err) { console.error(err); showToast("Failed to delete account.", "error");} 
            finally { loadingIndicator.style.display = 'none'; }
        };

        // --- TRANSACTION EDIT/DELETE ---
        window.openEditTransactionModal = (txId, txType) => {
            const transactions = appState[`${txType}Transactions`];
            const tx = transactions.find(t => t.id === txId);
            if (!tx) { showToast("Transaction not found.", "error"); return; }
            const modalId = `add${txType.charAt(0).toUpperCase() + txType.slice(1)}TransactionModal`;
            const form = document.getElementById(modalId.replace('Modal', 'Form'));
            form.dataset.editId = txId;
            form.querySelector('[id*="Date"]').value = tx.date;
            form.querySelector('[id*="Type"]').value = tx.type;
            form.querySelector('[id*="Amount"]').value = tx.amount;
            form.querySelector('[id*="Description"]').value = tx.description;
            populateAllAccountsDropdown(form.querySelector('[id*="Account"]').id, tx.accountId);
            populateCategoriesDropdown(form.querySelector('[id*="Category"]').id, tx.category);
            const modal = document.getElementById(modalId);
            modal.querySelector('h2').textContent = `Edit ${txType.charAt(0).toUpperCase() + txType.slice(1)} Transaction`;
            modal.querySelector('button[type="submit"]').textContent = 'Update Transaction';
            openModal(modalId);
        };

        window.deleteTransaction = async (txId, txType) => {
            if (!confirm("Are you sure you want to delete this transaction?")) return;
            const transactions = appState[`${txType}Transactions`];
            const tx = transactions.find(t => t.id === txId);
            if (!tx) { showToast("Transaction not found.", "error"); return; }
            loadingIndicator.style.display = 'flex';
            try {
                const batch = writeBatch(db);
                const txRef = doc(db, `users/${userId}/${txType}Transactions`, txId);
                batch.delete(txRef);
                const accountRef = doc(db, `users/${userId}/accounts`, tx.accountId);
                const balanceChange = tx.type === 'expense' ? tx.amount : -tx.amount;
                batch.update(accountRef, { balance: increment(balanceChange) });
                await batch.commit();
                showToast("Transaction deleted.", "success");
            } catch (err) {
                console.error("Error deleting transaction: ", err);
                showToast("Failed to delete transaction.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        };

        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCatInput = document.getElementById('newCategoryName');
            const newCat = newCatInput.value.trim();
            if (newCat && !appState.categories.includes(newCat)) {
                const updatedCategories = [...appState.categories, newCat];
                await setDoc(doc(db, `users/${userId}/appData/categories`), { list: updatedCategories });
                showToast("Category added!", "success");
                newCatInput.value = '';
            }
        });
        
        window.deleteCategory = async (categoryName) => {
            if (!confirm(`Are you sure you want to delete the category "${categoryName}"?`)) return;
            const updatedCategories = appState.categories.filter(c => c !== categoryName);
            await setDoc(doc(db, `users/${userId}/appData/categories`), { list: updatedCategories });
            showToast("Category removed.", "success");
        }

        function renderCategoryList() {
            const listEl = document.getElementById('categoryList'); if (!listEl) return;
            listEl.innerHTML = appState.categories.map(cat => `<div class="flex justify-between items-center bg-theme-light/5 p-2 rounded-lg"><span>${cat}</span><button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('');
            lucide.createIcons();
        }

        function populateAllAccountsDropdown(id, selectedValue) {
            const sel = document.getElementById(id); if(!sel) return;
            sel.innerHTML = '<option value="">Select Account</option>' + appState.accounts.map(a => `<option value="${a.id}" ${selectedValue === a.id ? 'selected':''}>${a.name}</option>`).join('');
        }
        function populateBankAccountsDropdown(id, selectedValue, element) {
            const sel = element || document.getElementById(id); if(!sel) return;
            const bankAccounts = appState.accounts.filter(a => a.type === 'Bank');
            sel.innerHTML = '<option value="">Select Bank</option>' + bankAccounts.map(a => `<option value="${a.name}" ${selectedValue === a.name ? 'selected':''}>${a.name}</option>`).join('');
            if(bankAccounts.length === 0) sel.innerHTML = '<option value="">No bank accounts found</option>';
        }
        function populateCategoriesDropdown(id, selectedValue) {
            const sel = document.getElementById(id); if(!sel) return;
            sel.innerHTML = '<option value="">Select Category</option>' + appState.categories.map(c => `<option value="${c}" ${selectedValue === c ? 'selected':''}>${c}</option>`).join('');
        }

        function resetForm(form) {
            if (!form) return;
            form.reset();
            delete form.dataset.accountId;
            delete form.dataset.accountType;
            delete form.dataset.editId; // Clear transaction edit id
        }
        
        function showToast(message, type = 'success') {
            const cont = document.getElementById('toastContainer');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-500 text-theme-dark' };
            const toast = document.createElement('div');
            toast.className = `toast text-white p-4 rounded-lg shadow-lg mb-2 ${colors[type]}`;
            toast.textContent = message;
            cont.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        initialize();
    </script>
</body>
</html>


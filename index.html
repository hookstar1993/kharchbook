<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal & Home Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5); /* Slate 800 with 50% opacity */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.125);
        }
        .modal-backdrop {
             background: rgba(15, 23, 42, 0.7); /* Slate 900 with 70% opacity */
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
        }
        .nav-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-button.active {
            color: #f8fafc; /* Slate 50 */
        }
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #8b5cf6; /* Violet 500 */
            border-radius: 1px;
        }
        .toast {
            animation: slideInRight 0.5s ease-out, fadeOut 0.5s ease-in 2.5s;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .account-type-card {
            transition: all 0.2s ease-in-out;
        }
        .account-type-card:hover {
            transform: translateY(-5px);
            background: rgba(45, 55, 72, 0.7);
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex justify-center items-center mb-8">
            <nav class="glass-card p-2 rounded-full">
                <div id="mainNav" class="flex items-center gap-2">
                    <button onclick="switchView('personal')" data-view="personal" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-slate-300">Personal</button>
                    <button onclick="switchView('home')" data-view="home" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-slate-300">Home</button>
                    <button onclick="switchView('accounts')" data-view="accounts" class="nav-button py-2 px-6 rounded-full text-sm font-semibold text-slate-300">Accounts</button>
                </div>
            </nav>
        </header>

        <main id="viewContainer">
            <!-- Views will be dynamically rendered here -->
        </main>

    </div>
    
    <!-- Modals -->

    <!-- Add Personal Transaction Modal -->
    <div id="addPersonalTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('addPersonalTransactionModal')"></div>
        <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('addPersonalTransactionModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6">Add Personal Transaction</h2>
            <form id="addPersonalTransactionForm" class="space-y-4">
                <div>
                    <label for="personalTxDate" class="block text-xs font-medium text-gray-400 mb-1">Date</label>
                    <input type="date" id="personalTxDate" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="personalTxType" class="block text-xs font-medium text-gray-400 mb-1">Type</label>
                        <select id="personalTxType" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div>
                        <label for="personalTxAccount" class="block text-xs font-medium text-gray-400 mb-1">Account</label>
                        <select id="personalTxAccount" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label for="personalTxCategory" class="block text-xs font-medium text-gray-400 mb-1">Category</label>
                        <select id="personalTxCategory" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                    </div>
                    <div>
                        <label for="personalTxAmount" class="block text-xs font-medium text-gray-400 mb-1">Amount</label>
                        <input type="number" id="personalTxAmount" placeholder="0.00" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                    </div>
                </div>
                <div>
                    <label for="personalTxDescription" class="block text-xs font-medium text-gray-400 mb-1">Description</label>
                    <input type="text" id="personalTxDescription" placeholder="e.g., Lunch with friends" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <button type="submit" class="w-full p-4 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition-all">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Add Home Transaction Modal -->
     <div id="addHomeTransactionModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('addHomeTransactionModal')"></div>
        <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('addHomeTransactionModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6">Add Home Transaction</h2>
            <form id="addHomeTransactionForm" class="space-y-4">
                <div>
                    <label for="homeTxDate" class="block text-xs font-medium text-gray-400 mb-1">Date</label>
                    <input type="date" id="homeTxDate" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="homeTxType" class="block text-xs font-medium text-gray-400 mb-1">Type</label>
                        <select id="homeTxType" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div>
                        <label for="homeTxAccount" class="block text-xs font-medium text-gray-400 mb-1">Account</label>
                        <select id="homeTxAccount" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="homeTxCategory" class="block text-xs font-medium text-gray-400 mb-1">Category</label>
                        <select id="homeTxCategory" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                    </div>
                    <div>
                        <label for="homeTxAmount" class="block text-xs font-medium text-gray-400 mb-1">Amount</label>
                        <input type="number" id="homeTxAmount" placeholder="0.00" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                    </div>
                </div>
                <div>
                    <label for="homeTxDescription" class="block text-xs font-medium text-gray-400 mb-1">Description</label>
                    <input type="text" id="homeTxDescription" placeholder="e.g., Monthly groceries" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <button type="submit" class="w-full p-4 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition-all">Save Transaction</button>
            </form>
        </div>
    </div>
    
     <!-- Add Account Type Selection Modal -->
    <div id="addAccountTypeModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('addAccountTypeModal')"></div>
        <div class="glass-card w-full max-w-2xl m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('addAccountTypeModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Select Account Type</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button onclick="selectAccountType('Bank')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="landmark" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">Bank</span>
                </button>
                <button onclick="selectAccountType('Credit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="credit-card" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">Credit Card</span>
                </button>
                 <button onclick="selectAccountType('Debit Card')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="credit-card" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">Debit Card</span>
                </button>
                <button onclick="selectAccountType('Wallet')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="wallet" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">Wallet</span>
                </button>
                <button onclick="selectAccountType('UPI')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="zap" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">UPI</span>
                </button>
                 <button onclick="selectAccountType('Cash')" class="account-type-card glass-card p-6 flex flex-col items-center justify-center gap-2 rounded-lg">
                    <i data-lucide="banknote" class="w-8 h-8 text-violet-400"></i>
                    <span class="font-semibold text-white">Cash</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Bank Account Modal -->
    <div id="addBankAccountModal" class="fixed inset-0 z-50 items-center justify-center hidden">
         <div class="modal-backdrop absolute inset-0" onclick="closeModal('addBankAccountModal')"></div>
         <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
             <button onclick="closeModal('addBankAccountModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
             <h2 class="text-2xl font-bold text-white mb-6">Add Bank Account</h2>
             <form id="addBankAccountForm" class="space-y-4">
                <div>
                    <label for="bankAccountName" class="block text-xs font-medium text-gray-400 mb-1">Account Nickname</label>
                    <input type="text" id="bankAccountName" placeholder="e.g., My Savings" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="bankAccountBalance" class="block text-xs font-medium text-gray-400 mb-1">Initial Balance</label>
                    <input type="number" id="bankAccountBalance" placeholder="0.00" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div class="space-y-4 pt-2">
                    <div>
                        <label for="bankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                        <input type="text" id="bankName" placeholder="e.g., State Bank of India" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                             <label for="accountNumber" class="block text-xs font-medium text-gray-400 mb-1">Account Number</label>
                             <input type="text" id="accountNumber" placeholder="Last 6 digits are shown" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                        </div>
                        <div>
                             <label for="ifscCode" class="block text-xs font-medium text-gray-400 mb-1">IFSC Code</label>
                             <input type="text" id="ifscCode" placeholder="e.g., SBIN0001234" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                        </div>
                    </div>
                    <div>
                        <label for="branchName" class="block text-xs font-medium text-gray-400 mb-1">Branch Name</label>
                        <input type="text" id="branchName" placeholder="e.g., Main Branch" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                    </div>
                </div>
                 <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Account</button>
             </form>
         </div>
    </div>

    <!-- Add Credit Card Modal -->
    <div id="addCreditCardModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('addCreditCardModal')"></div>
        <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('addCreditCardModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6">Add Credit Card</h2>
            <form id="addCreditCardForm" class="space-y-4">
                <div>
                    <label for="creditCardNickname" class="block text-xs font-medium text-gray-400 mb-1">Card Nickname</label>
                    <input type="text" id="creditCardNickname" placeholder="e.g., HDFC Millennia" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="creditCardBankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                    <input type="text" id="creditCardBankName" placeholder="e.g., HDFC Bank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="creditCardLastFour" class="block text-xs font-medium text-gray-400 mb-1">Last 4 Digits</label>
                        <input type="number" id="creditCardLastFour" placeholder="1234" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                    </div>
                    <div>
                        <label for="creditCardLimit" class="block text-xs font-medium text-gray-400 mb-1">Credit Limit</label>
                        <input type="number" id="creditCardLimit" placeholder="50000" step="100" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                    </div>
                </div>
                <div>
                    <label for="creditCardLinkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                    <select id="creditCardLinkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                </div>
                <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Credit Card</button>
            </form>
        </div>
    </div>

    <!-- Add Debit Card Modal -->
    <div id="addDebitCardModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('addDebitCardModal')"></div>
        <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('addDebitCardModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6">Add Debit Card</h2>
            <form id="addDebitCardForm" class="space-y-4">
                <div>
                    <label for="debitCardNickname" class="block text-xs font-medium text-gray-400 mb-1">Card Nickname</label>
                    <input type="text" id="debitCardNickname" placeholder="e.g., SBI Global" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                 <div>
                    <label for="debitCardBankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                    <input type="text" id="debitCardBankName" placeholder="e.g., State Bank of India" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="debitCardLastFour" class="block text-xs font-medium text-gray-400 mb-1">Last 4 Digits</label>
                    <input type="number" id="debitCardLastFour" placeholder="1234" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                 <div>
                    <label for="debitCardLinkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                    <select id="debitCardLinkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                </div>
                <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Debit Card</button>
            </form>
        </div>
    </div>


    <!-- Add Wallet Modal -->
    <div id="addWalletModal" class="fixed inset-0 z-50 items-center justify-center hidden">
         <div class="modal-backdrop absolute inset-0" onclick="closeModal('addWalletModal')"></div>
         <div class="glass-card w-full max-w-sm m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
             <button onclick="closeModal('addWalletModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
             <h2 class="text-2xl font-bold text-white mb-6">Add Wallet</h2>
             <form id="addWalletForm" class="space-y-4">
                <div>
                    <label for="walletName" class="block text-xs font-medium text-gray-400 mb-1">Wallet Name</label>
                    <input type="text" id="walletName" placeholder="e.g., Paytm" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="walletBalance" class="block text-xs font-medium text-gray-400 mb-1">Initial Balance</label>
                    <input type="number" id="walletBalance" placeholder="0.00" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="walletLinkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                    <select id="walletLinkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                </div>
                <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Wallet</button>
             </form>
         </div>
    </div>

    <!-- Add UPI Modal -->
    <div id="addUpiModal" class="fixed inset-0 z-50 items-center justify-center hidden">
         <div class="modal-backdrop absolute inset-0" onclick="closeModal('addUpiModal')"></div>
         <div class="glass-card w-full max-w-sm m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
             <button onclick="closeModal('addUpiModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
             <h2 class="text-2xl font-bold text-white mb-6">Add UPI App</h2>
             <form id="addUpiForm" class="space-y-4">
                <div>
                     <label for="upiAppName" class="block text-xs font-medium text-gray-400 mb-1">UPI App Name</label>
                    <input type="text" id="upiAppName" placeholder="e.g., Google Pay" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="upiId" class="block text-xs font-medium text-gray-400 mb-1">UPI ID (Optional)</label>
                    <input type="text" id="upiId" placeholder="yourname@bank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                </div>
                <div>
                    <label for="upiLinkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                    <select id="upiLinkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                </div>
                <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save UPI</button>
             </form>
         </div>
    </div>
    
    <!-- Add Cash Modal -->
    <div id="addCashModal" class="fixed inset-0 z-50 items-center justify-center hidden">
         <div class="modal-backdrop absolute inset-0" onclick="closeModal('addCashModal')"></div>
         <div class="glass-card w-full max-w-sm m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
             <button onclick="closeModal('addCashModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
             <h2 class="text-2xl font-bold text-white mb-6">Add Cash Account</h2>
             <form id="addCashForm" class="space-y-4">
                <div>
                    <label for="cashNickname" class="block text-xs font-medium text-gray-400 mb-1">Nickname</label>
                    <input type="text" id="cashNickname" placeholder="e.g., Cash in Hand" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <div>
                    <label for="cashBalance" class="block text-xs font-medium text-gray-400 mb-1">Initial Balance</label>
                    <input type="number" id="cashBalance" placeholder="0.00" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
                <button type="submit" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all">Save Cash</button>
             </form>
         </div>
    </div>
    
    <div id="manageCategoriesModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('manageCategoriesModal')"></div>
        <div class="glass-card w-full max-w-md m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('manageCategoriesModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-bold text-white mb-6">Manage Categories</h2>
            <form id="addCategoryForm" class="flex gap-2 mb-4">
                <input type="text" id="newCategoryName" placeholder="New category name" class="flex-grow p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                <button type="submit" class="p-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-all"><i data-lucide="plus" class="w-6 h-6"></i></button>
            </form>
            <div id="categoryList" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="editAccountModal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeModal('editAccountModal')"></div>
        <div class="glass-card w-full max-w-lg m-4 p-8 relative transform transition-all" style="opacity: 0; transform: scale(0.95);">
            <button onclick="closeModal('editAccountModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 id="editAccountTitle" class="text-2xl font-bold text-white mb-6">Edit Account</h2>
            <form id="editAccountForm" class="space-y-4">
                <input type="hidden" id="editAccountId">
                <input type="hidden" id="editAccountType">
                <div id="editAccountFields" class="space-y-4">
                    <!-- Dynamic fields will be injected here -->
                </div>
                <button type="submit" class="w-full p-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-all">Save Changes</button>
            </form>
        </div>
    </div>


    <!-- Loading indicator -->
    <div id="loadingIndicator" class="fixed inset-0 z-50 items-center justify-center hidden bg-black/50"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div></div>
    
    <!-- Toast Notification -->
    <div id="toastContainer" class="fixed top-5 right-5 z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- App State ---
        let db, auth, userId;
        let appState = {
            accounts: [],
            personalTransactions: [],
            homeTransactions: [],
            categories: [],
            currentView: 'personal'
        };
        let charts = {};

        // --- Firebase Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };

        // --- UI Elements ---
        const viewContainer = document.getElementById('viewContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainNav = document.getElementById('mainNav');

        // --- App Initialization ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await fetchInitialData();
                        switchView('personal'); // Default to personal view
                    } else {
                         if (typeof __initial_auth_token !== 'undefined') { 
                            await signInWithCustomToken(auth, __initial_auth_token);
                         } else { 
                            await signInAnonymously(auth); 
                         }
                    }
                });
            } catch (err) {
                console.error("Firebase initialization error: ", err);
                viewContainer.innerHTML = `<p class="text-center text-red-400">Error connecting to the database.</p>`;
            }
        }
        
        // --- Data Fetching & Subscriptions ---
        async function fetchInitialData() {
            loadingIndicator.style.display = 'flex';
            
            onSnapshot(collection(db, `/artifacts/${appId}/users/${userId}/accounts`), (snapshot) => {
                appState.accounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.currentView === 'accounts') renderAccountsView();
            });

            onSnapshot(query(collection(db, `/artifacts/${appId}/users/${userId}/personalTransactions`), orderBy("date", "desc")), (snapshot) => {
                appState.personalTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (appState.currentView === 'personal') renderPersonalView();
            });

            onSnapshot(query(collection(db, `/artifacts/${appId}/users/${userId}/homeTransactions`), orderBy("date", "desc")), (snapshot) => {
                appState.homeTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (appState.currentView === 'home') renderHomeView();
            });

            onSnapshot(doc(db, `/artifacts/${appId}/users/${userId}/appData/categories`), (docSnap) => {
                if (docSnap.exists() && docSnap.data().list) {
                    appState.categories = docSnap.data().list;
                } else {
                    const defaultCategories = ["Food", "Transport", "Bills", "Shopping", "Health", "Entertainment", "Groceries", "Other"];
                    setDoc(doc(db, `/artifacts/${appId}/users/${userId}/appData/categories`), { list: defaultCategories });
                    appState.categories = defaultCategories;
                }
                if(document.getElementById('categoryList')) renderCategoryList();
            });

            loadingIndicator.style.display = 'none';
        }

        // --- View Rendering ---
        window.switchView = (view) => {
            appState.currentView = view;
            mainNav.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            switch (view) {
                case 'personal': renderPersonalView(); break;
                case 'home': renderHomeView(); break;
                case 'accounts': renderAccountsView(); break;
            }
        }
        
        function renderPersonalView() {
            const personalIncome = appState.personalTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const personalExpense = appState.personalTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const personalBalance = personalIncome - personalExpense;

            viewContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Balance</h3>
                        <p class="text-3xl font-bold text-white mt-2">₹${personalBalance.toFixed(2)}</p>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Income</h3>
                        <p class="text-3xl font-bold text-green-400 mt-2">₹${personalIncome.toFixed(2)}</p>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Expense</h3>
                        <p class="text-3xl font-bold text-red-400 mt-2">₹${personalExpense.toFixed(2)}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">Recent Transactions</h2>
                            <button id="addPersonalTxBtn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Add
                            </button>
                        </div>
                        <div id="personalTxList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="lg:col-span-2 glass-card p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Spending by Category</h3>
                        <canvas id="personalSpendingChart"></canvas>
                    </div>
                </div>
            `;
            renderTransactionList('personalTxList', appState.personalTransactions);
            createCategoryDoughnutChart('personalSpendingChart', appState.personalTransactions);
            lucide.createIcons();
            document.getElementById('addPersonalTxBtn').addEventListener('click', () => {
                document.getElementById('personalTxDate').valueAsDate = new Date();
                populateAllAccountsDropdown('personalTxAccount');
                populateCategoriesDropdown('personalTxCategory');
                openModal('addPersonalTransactionModal');
            });
        }

        function renderHomeView() {
            const homeIncome = appState.homeTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const homeExpense = appState.homeTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const homeBalance = homeIncome - homeExpense;

            viewContainer.innerHTML = `
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Home Balance</h3>
                        <p class="text-3xl font-bold text-white mt-2">₹${homeBalance.toFixed(2)}</p>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Home Income</h3>
                        <p class="text-3xl font-bold text-green-400 mt-2">₹${homeIncome.toFixed(2)}</p>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-sm font-medium text-slate-400">Home Expense</h3>
                        <p class="text-3xl font-bold text-red-400 mt-2">₹${homeExpense.toFixed(2)}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">Recent Home Transactions</h2>
                            <button id="addHomeTxBtn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Add Transaction
                            </button>
                        </div>
                        <div id="homeTxList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="lg:col-span-2 glass-card p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Spending by Category</h3>
                        <canvas id="homeSpendingChart"></canvas>
                    </div>
                </div>
            `;
            renderTransactionList('homeTxList', appState.homeTransactions);
            createCategoryDoughnutChart('homeSpendingChart', appState.homeTransactions);
            lucide.createIcons();
             document.getElementById('addHomeTxBtn').addEventListener('click', () => {
                document.getElementById('homeTxDate').valueAsDate = new Date();
                populateAllAccountsDropdown('homeTxAccount');
                populateCategoriesDropdown('homeTxCategory');
                openModal('addHomeTransactionModal');
            });
        }
        
        function renderAccountsView() {
            viewContainer.innerHTML = `
                <div>
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h2 class="text-3xl font-bold text-white">My Accounts & Settings</h2>
                        <div class="flex items-center gap-4">
                           <button onclick="openModal('manageCategoriesModal')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm">
                               <i data-lucide="settings-2" class="w-4 h-4"></i> Manage Categories
                           </button>
                            <button id="addAccountBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm">
                               <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Account
                            </button>
                        </div>
                    </div>
                    
                    <div id="accountsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <p id="noAccountsMessage" class="hidden text-center text-slate-400 py-8">No accounts found. Click "Add Account" to get started.</p>
                </div>
            `;
            renderAccountsList();
            lucide.createIcons();
            document.getElementById('addAccountBtn').addEventListener('click', () => {
                openModal('addAccountTypeModal');
            });
        }

        function renderTransactionList(elementId, transactions) {
            const listEl = document.getElementById(elementId);
            if (!listEl) return;

            if (transactions.length === 0) {
                listEl.innerHTML = `<div class="glass-card p-8 text-center text-slate-400">No transactions yet.</div>`;
                return;
            }

            listEl.innerHTML = transactions.map(tx => {
                const isExpense = tx.type === 'expense';
                const amountClass = isExpense ? 'text-red-400' : 'text-green-400';
                const sign = isExpense ? '-' : '+';
                const account = appState.accounts.find(a => a.id === tx.accountId);
                
                let accountName = 'Unknown Account';
                if(account) {
                    accountName = account.type === 'Bank' && account.accountNumber ? `${account.bankName} (...${account.accountNumber.slice(-6)})` : account.name;
                }
                
                return `
                    <div class="glass-card p-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isExpense ? 'bg-red-500/10' : 'bg-green-500/10'}">
                                <i data-lucide="${isExpense ? 'arrow-down' : 'arrow-up'}" class="w-5 h-5 ${isExpense ? 'text-red-400' : 'text-green-400'}"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-white">${tx.description || tx.category}</p>
                                <p class="text-sm text-slate-400">${new Date(tx.date).toLocaleDateString()} &bull; ${accountName}</p>
                            </div>
                        </div>
                        <p class="font-bold text-lg ${amountClass}">${sign}₹${tx.amount.toFixed(2)}</p>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderAccountsList() {
            const listEl = document.getElementById('accountsList');
            const noAccountsMessage = document.getElementById('noAccountsMessage');
            if (!listEl || !noAccountsMessage) return;

            if (appState.accounts.length === 0) {
                listEl.classList.add('hidden');
                noAccountsMessage.classList.remove('hidden');
                return;
            }

            listEl.classList.remove('hidden');
            noAccountsMessage.classList.add('hidden');
            
            const typeIcons = {
                'Bank': 'landmark', 'Credit Card': 'credit-card', 'Debit Card': 'credit-card',
                'Wallet': 'wallet', 'UPI': 'zap', 'Cash': 'banknote'
            };

            listEl.innerHTML = appState.accounts.map(acc => {
                const isBank = acc.type === 'Bank';
                const isCard = acc.type === 'Credit Card' || acc.type === 'Debit Card';
                const maskedAccountNumber = isBank && acc.accountNumber ? `******${acc.accountNumber.slice(-6)}` : '';
                const cardLastFour = isCard && acc.lastFour ? `**** ${acc.lastFour}`: '';

                let bottomDetailHTML = '';
                if (isBank) {
                    bottomDetailHTML = `<div class="text-xs text-gray-300 mt-1"><p>${acc.bankName || ''}</p><p>${maskedAccountNumber}</p></div>`;
                } else if (acc.type === 'UPI') {
                    bottomDetailHTML = `<p class="text-xs text-gray-300 mt-1">${acc.upiId || ''}</p>`;
                } else if (isCard) {
                    bottomDetailHTML = `<div class="text-xs text-gray-300 mt-1"><p>${acc.bankName || ''}</p><p>${cardLastFour}</p></div>`;
                }

                if (acc.linkedBank) {
                    bottomDetailHTML += `<p class="text-xs text-gray-400 mt-2">Linked to: <b>${acc.linkedBank}</b></p>`;
                }

                let balanceHTML = '';
                if (typeof acc.balance === 'number') {
                    balanceHTML = `<p class="text-3xl font-bold mt-4 text-white">₹${acc.balance.toFixed(2)}</p>`;
                } else if (acc.type === 'Credit Card' && typeof acc.creditLimit === 'number') {
                    balanceHTML = `<div class="mt-4"><span class="text-sm text-gray-400">Limit</span><p class="text-2xl font-bold text-white">₹${acc.creditLimit.toFixed(2)}</p></div>`;
                }

                const accountString = JSON.stringify(acc).replace(/"/g, "'");

                return `<div class="glass-card p-6 flex flex-col justify-between"><div><div class="flex justify-between items-start"><span class="text-sm text-gray-400">${acc.type}</span><div class="flex items-center gap-2"><button onclick="openEditAccountModal(${accountString})" class="text-gray-400 hover:text-white"><i data-lucide="pencil" class="w-4 h-4"></i></button><i data-lucide="${typeIcons[acc.type] || 'circle-dollar-sign'}" class="w-5 h-5 text-gray-400"></i></div></div><p class="text-xl font-semibold text-white mt-1">${acc.name}</p>${bottomDetailHTML}</div>${balanceHTML}</div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- Charting ---
        function createCategoryDoughnutChart(canvasId, transactions) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const expenseByCategory = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expenseByCategory);
            const data = Object.values(expenseByCategory);

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            const existingNoData = canvas.parentNode.querySelector('p.no-data-message');
            if (existingNoData) existingNoData.remove();
            
            if (labels.length === 0) {
                 canvas.style.display = 'none';
                 const noDataEl = document.createElement('p');
                 noDataEl.textContent = "No expense data to display.";
                 noDataEl.className = "text-center text-slate-400 py-10 no-data-message";
                 canvas.parentNode.appendChild(noDataEl);
                 return;
            }

            canvas.style.display = 'block';
            
            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expense',
                        data: data,
                        backgroundColor: ['#8b5cf6', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#ef4444', '#6b7280'],
                        borderColor: '#0f172a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8' // Slate 400
                            }
                        }
                    }
                }
            });
        }
        
        // --- Event Listeners & Actions ---
        
        window.selectAccountType = (type) => {
            const bankAccounts = appState.accounts.filter(acc => acc.type === 'Bank');
            const requiresBank = ['Credit Card', 'Debit Card', 'Wallet', 'UPI'].includes(type);

            if (requiresBank && bankAccounts.length === 0) {
                showToast("Please add a bank account first.", "warning");
                return; 
            }

            closeModal('addAccountTypeModal');
            // Use a timeout to ensure the first modal has started closing before opening the next
            setTimeout(() => {
                openAddAccountModal(type);
            }, 200);
        }

        window.openAddAccountModal = (type) => {
            let modalId;
            switch(type) {
                case 'Bank': modalId = 'addBankAccountModal'; break;
                case 'Credit Card': 
                    modalId = 'addCreditCardModal'; 
                    populateBankAccountsDropdown('creditCardLinkedBank');
                    break;
                case 'Debit Card': 
                    modalId = 'addDebitCardModal'; 
                    populateBankAccountsDropdown('debitCardLinkedBank');
                    break;
                case 'Wallet': 
                    modalId = 'addWalletModal'; 
                    populateBankAccountsDropdown('walletLinkedBank');
                    break;
                case 'UPI': 
                    modalId = 'addUpiModal';
                    populateBankAccountsDropdown('upiLinkedBank');
                    break;
                case 'Cash': modalId = 'addCashModal'; break;
            }
            if (modalId) openModal(modalId);
        }
        
        document.getElementById('addBankAccountForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'Bank', name: document.getElementById('bankAccountName').value, balance: parseFloat(document.getElementById('bankAccountBalance').value), bankName: document.getElementById('bankName').value, accountNumber: document.getElementById('accountNumber').value, ifscCode: document.getElementById('ifscCode').value, branchName: document.getElementById('branchName').value, createdAt: new Date().toISOString() };
            saveAccount(data, 'addBankAccountModal', 'addBankAccountForm');
        });

        document.getElementById('addCreditCardForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'Credit Card', name: document.getElementById('creditCardNickname').value, bankName: document.getElementById('creditCardBankName').value, lastFour: document.getElementById('creditCardLastFour').value, creditLimit: parseFloat(document.getElementById('creditCardLimit').value), linkedBank: document.getElementById('creditCardLinkedBank').value, createdAt: new Date().toISOString() };
            saveAccount(data, 'addCreditCardModal', 'addCreditCardForm');
        });

        document.getElementById('addDebitCardForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'Debit Card', name: document.getElementById('debitCardNickname').value, bankName: document.getElementById('debitCardBankName').value, lastFour: document.getElementById('debitCardLastFour').value, linkedBank: document.getElementById('debitCardLinkedBank').value, createdAt: new Date().toISOString() };
            saveAccount(data, 'addDebitCardModal', 'addDebitCardForm');
        });

         document.getElementById('addWalletForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'Wallet', name: document.getElementById('walletName').value, balance: parseFloat(document.getElementById('walletBalance').value), linkedBank: document.getElementById('walletLinkedBank').value, createdAt: new Date().toISOString() };
            saveAccount(data, 'addWalletModal', 'addWalletForm');
        });

        document.getElementById('addUpiForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'UPI', name: document.getElementById('upiAppName').value, upiId: document.getElementById('upiId').value, linkedBank: document.getElementById('upiLinkedBank').value, createdAt: new Date().toISOString() };
            saveAccount(data, 'addUpiModal', 'addUpiForm');
        });

        document.getElementById('addCashForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = { type: 'Cash', name: document.getElementById('cashNickname').value, balance: parseFloat(document.getElementById('cashBalance').value), createdAt: new Date().toISOString() };
            saveAccount(data, 'addCashModal', 'addCashForm');
        });

        document.getElementById('addPersonalTransactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('personalTxDate').value,
                type: document.getElementById('personalTxType').value,
                accountId: document.getElementById('personalTxAccount').value,
                category: document.getElementById('personalTxCategory').value,
                amount: parseFloat(document.getElementById('personalTxAmount').value),
                description: document.getElementById('personalTxDescription').value
            };
            saveTransaction('personal', data, 'addPersonalTransactionModal', 'addPersonalTransactionForm');
        });

        document.getElementById('addHomeTransactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('homeTxDate').value,
                type: document.getElementById('homeTxType').value,
                accountId: document.getElementById('homeTxAccount').value,
                category: document.getElementById('homeTxCategory').value,
                amount: parseFloat(document.getElementById('homeTxAmount').value),
                description: document.getElementById('homeTxDescription').value
            };
            saveTransaction('home', data, 'addHomeTransactionModal', 'addHomeTransactionForm');
        });


        document.getElementById('editAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const accountId = document.getElementById('editAccountId').value;
            const accountType = document.getElementById('editAccountType').value;
            if (!accountId || !accountType) {
                showToast("Could not find account to update.", "error");
                return;
            }

            loadingIndicator.style.display = 'flex';
            let updatedData = {};

            const commonFields = ['name', 'balance'];
            for (const field of commonFields) {
                const el = document.getElementById(`edit_${field}`);
                if(el) {
                    updatedData[field] = el.type === 'number' ? parseFloat(el.value) : el.value;
                }
            }

            switch(accountType) {
                case 'Bank':
                    updatedData.bankName = document.getElementById('edit_bankName').value;
                    updatedData.accountNumber = document.getElementById('edit_accountNumber').value;
                    updatedData.ifscCode = document.getElementById('edit_ifscCode').value;
                    updatedData.branchName = document.getElementById('edit_branchName').value;
                    break;
                case 'Credit Card':
                    updatedData.bankName = document.getElementById('edit_bankName').value;
                    updatedData.lastFour = document.getElementById('edit_lastFour').value;
                    updatedData.creditLimit = parseFloat(document.getElementById('edit_creditLimit').value);
                    updatedData.linkedBank = document.getElementById('edit_linkedBank').value;
                    break;
                case 'Debit Card':
                    updatedData.bankName = document.getElementById('edit_bankName').value;
                    updatedData.lastFour = document.getElementById('edit_lastFour').value;
                    updatedData.linkedBank = document.getElementById('edit_linkedBank').value;
                    break;
                case 'Wallet':
                    updatedData.linkedBank = document.getElementById('edit_linkedBank').value;
                    break;
                case 'UPI':
                    updatedData.upiId = document.getElementById('edit_upiId').value;
                    updatedData.linkedBank = document.getElementById('edit_linkedBank').value;
                    break;
            }

            try {
                const accountRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, accountId);
                await updateDoc(accountRef, updatedData);
                showToast("Account updated successfully!", "success");
                closeModal('editAccountModal');
            } catch (err) {
                console.error("Error updating account: ", err);
                showToast("Failed to update account.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCategoryName = document.getElementById('newCategoryName').value.trim();
            if (newCategoryName && !appState.categories.includes(newCategoryName)) {
                const updatedCategories = [...appState.categories, newCategoryName];
                try {
                    const categoriesDocRef = doc(db, `/artifacts/${appId}/users/${userId}/appData/categories`);
                    await setDoc(categoriesDocRef, { list: updatedCategories }, { merge: true });
                    showToast("Category added!", "success");
                    document.getElementById('addCategoryForm').reset();
                } catch(err) { showToast("Failed to add category.", "error"); }
            }
        });

        async function saveAccount(data, modalId, formId) {
            loadingIndicator.style.display = 'flex';
            try {
                const accountsCollection = collection(db, `/artifacts/${appId}/users/${userId}/accounts`);
                await addDoc(accountsCollection, data);
                showToast("Account added successfully!", "success");
                closeModal(modalId);
                document.getElementById(formId).reset();
            } catch (err) {
                console.error("Error saving account: ", err);
                showToast("Failed to save account.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        async function saveTransaction(txType, data, modalId, formId) {
            loadingIndicator.style.display = 'flex';
            
            const accountRef = doc(db, `/artifacts/${appId}/users/${userId}/accounts`, data.accountId);
            const account = appState.accounts.find(a => a.id === data.accountId);
            
            if (!account) {
                 showToast("Selected account not found.", "error");
                 loadingIndicator.style.display = 'none';
                 return;
            }
            
            let balanceUpdate = 0;
            if (typeof account.balance === 'number') {
                balanceUpdate = data.type === 'income' ? data.amount : -data.amount;
            }

            try {
                const batch = writeBatch(db);
                
                const txCollectionPath = txType === 'personal' ? 'personalTransactions' : 'homeTransactions';
                const txCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/${txCollectionPath}`);
                batch.set(doc(txCollectionRef), { ...data, createdAt: new Date().toISOString() });
                
                if (balanceUpdate !== 0) {
                    batch.update(accountRef, { balance: increment(balanceUpdate) });
                }

                await batch.commit();

                showToast("Transaction saved successfully!", "success");
                closeModal(modalId);
                document.getElementById(formId).reset();
            } catch (err) {
                console.error("Error saving transaction: ", err);
                showToast("Failed to save transaction.", "error");
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        window.deleteCategory = async (categoryToDelete) => {
            const updatedCategories = appState.categories.filter(c => c !== categoryToDelete);
            try {
                const categoriesDocRef = doc(db, `/artifacts/${appId}/users/${userId}/appData/categories`);
                await setDoc(categoriesDocRef, { list: updatedCategories });
                showToast("Category deleted.", "success");
            } catch(err) { showToast("Failed to delete category.", "error"); }
        }

        window.openEditAccountModal = (account) => {
            document.getElementById('editAccountId').value = account.id;
            document.getElementById('editAccountType').value = account.type;
            document.getElementById('editAccountTitle').textContent = `Edit ${account.type} Account`;
            
            const fieldsContainer = document.getElementById('editAccountFields');
            let fieldsHTML = `
                <div>
                    <label for="edit_name" class="block text-xs font-medium text-gray-400 mb-1">Account Nickname</label>
                    <input type="text" id="edit_name" value="${account.name}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                </div>
            `;

            if (typeof account.balance === 'number') {
                fieldsHTML += `
                    <div>
                        <label for="edit_balance" class="block text-xs font-medium text-gray-400 mb-1">Balance</label>
                        <input type="number" id="edit_balance" value="${account.balance}" step="0.01" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                    </div>`;
            }

            switch(account.type) {
                case 'Bank':
                    fieldsHTML += `
                        <div>
                            <label for="edit_bankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                            <input type="text" id="edit_bankName" value="${account.bankName || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_accountNumber" class="block text-xs font-medium text-gray-400 mb-1">Account Number</label>
                                <input type="text" id="edit_accountNumber" value="${account.accountNumber || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                            </div>
                            <div>
                                <label for="edit_ifscCode" class="block text-xs font-medium text-gray-400 mb-1">IFSC Code</label>
                                <input type="text" id="edit_ifscCode" value="${account.ifscCode || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                            </div>
                        </div>
                        <div>
                            <label for="edit_branchName" class="block text-xs font-medium text-gray-400 mb-1">Branch Name</label>
                            <input type="text" id="edit_branchName" value="${account.branchName || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                        </div>
                    `;
                    break;
                case 'Credit Card':
                    fieldsHTML += `
                        <div>
                            <label for="edit_bankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                            <input type="text" id="edit_bankName" value="${account.bankName || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="edit_lastFour" class="block text-xs font-medium text-gray-400 mb-1">Last 4 Digits</label>
                                <input type="number" id="edit_lastFour" value="${account.lastFour || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                            </div>
                            <div>
                                <label for="edit_creditLimit" class="block text-xs font-medium text-gray-400 mb-1">Credit Limit</label>
                                <input type="number" id="edit_creditLimit" value="${account.creditLimit || ''}" step="100" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                            </div>
                        </div>
                        <div>
                            <label for="edit_linkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                            <select id="edit_linkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                        </div>
                    `;
                    break;
                case 'Debit Card':
                     fieldsHTML += `
                        <div>
                            <label for="edit_bankName" class="block text-xs font-medium text-gray-400 mb-1">Bank Name</label>
                            <input type="text" id="edit_bankName" value="${account.bankName || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                        </div>
                        <div>
                            <label for="edit_lastFour" class="block text-xs font-medium text-gray-400 mb-1">Last 4 Digits</label>
                            <input type="number" id="edit_lastFour" value="${account.lastFour || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required>
                        </div>
                        <div>
                            <label for="edit_linkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                            <select id="edit_linkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                        </div>
                    `;
                    break;
                case 'Wallet':
                    fieldsHTML += `
                        <div>
                            <label for="edit_linkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                            <select id="edit_linkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                        </div>`;
                    break;
                case 'UPI':
                     fieldsHTML += `
                        <div>
                             <label for="edit_upiId" class="block text-xs font-medium text-gray-400 mb-1">UPI ID (Optional)</label>
                            <input type="text" id="edit_upiId" value="${account.upiId || ''}" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white">
                        </div>
                        <div>
                            <label for="edit_linkedBank" class="block text-xs font-medium text-gray-400 mb-1">Linked Bank Account</label>
                            <select id="edit_linkedBank" class="w-full p-3 bg-white/5 rounded-lg border border-white/10 focus:outline-none focus:ring-2 focus:ring-purple-500 text-white" required></select>
                        </div>
                     `;
                    break;
            }

            fieldsContainer.innerHTML = fieldsHTML;

            const linkedBankDropdown = document.getElementById('edit_linkedBank');
            if (linkedBankDropdown) {
                populateBankAccountsDropdown('edit_linkedBank');
                setTimeout(() => { 
                    linkedBankDropdown.value = account.linkedBank;
                }, 100);
            }
            
            openModal('editAccountModal');
        }

        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => {
                const card = modal.querySelector('.glass-card');
                card.style.opacity = '1';
                card.style.transform = 'scale(1)';
            }, 50);
            lucide.createIcons();
        };

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            const card = modal.querySelector('.glass-card');
            card.style.opacity = '0';
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        };

        // --- Utility Functions ---
        function populateBankAccountsDropdown(selectId) {
            const selectEl = document.getElementById(selectId);
            const bankAccounts = appState.accounts.filter(acc => acc.type === 'Bank');
            selectEl.innerHTML = '<option value="">Select a bank account</option>';
            bankAccounts.forEach(acc => {
                const displayText = acc.accountNumber ? `${acc.bankName} (...${acc.accountNumber.slice(-6)})` : acc.name;
                selectEl.innerHTML += `<option value="${displayText}">${displayText}</option>`;
            });
        }
        
        function populateAllAccountsDropdown(selectId) {
            const selectEl = document.getElementById(selectId);
            const usableAccounts = appState.accounts.filter(acc => typeof acc.balance === 'number');
            selectEl.innerHTML = '<option value="">Select an account</option>';
            usableAccounts.forEach(acc => {
                 const displayText = acc.type === 'Bank' && acc.accountNumber ? `${acc.bankName} (...${acc.accountNumber.slice(-6)})` : acc.name;
                selectEl.innerHTML += `<option value="${acc.id}">${displayText}</option>`;
            });
        }
        
        function populateCategoriesDropdown(selectId) {
            const selectEl = document.getElementById(selectId);
            selectEl.innerHTML = '<option value="">Select a category</option>';
            appState.categories.forEach(cat => {
                selectEl.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function renderCategoryList() {
            const listEl = document.getElementById('categoryList');
            if (!listEl) return;
            listEl.innerHTML = appState.categories.map(cat => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg">
                    <span class="text-slate-200">${cat}</span>
                    <button onclick="deleteCategory('${cat}')" class="text-red-400 hover:text-red-300"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600'
            };
            toast.className = `toast text-white p-4 rounded-lg shadow-lg mb-2 ${colors[type]}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- Start the App ---
        initialize();
        lucide.createIcons();
    </script>
</body>
</html>



